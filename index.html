<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 æ—¥æœ¬é—œè¥¿/å±±é™½ä¹‹æ—… (è‡ªå‹•å°‹åœ–ä¿®æ­£ç‰ˆ)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons (Lightweight icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, setDoc, deleteDoc, runTransaction, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            setLogLevel('debug'); // Enable debug logging for Firebase
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // --- FIX: Expose necessary Firebase functions to global scope for React ---
            window.onAuthStateChanged = onAuthStateChanged;
            window.collection = collection;
            window.onSnapshot = onSnapshot;
            window.doc = doc;
            window.setDoc = setDoc;
            window.deleteDoc = deleteDoc;
            window.getDocs = getDocs; 
            // --------------------------------------------------------------------------

            // Authentication logic
            onAuthStateChanged(window.auth, async (user) => {
                if (!user) {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (error) {
                        console.error("Firebase Sign-in failed:", error);
                    }
                }
                // Once authenticated, the global db/auth objects are ready for the React app
            });
        } else {
            console.error("Firebase configuration is missing or invalid.");
            window.db = null;
            window.auth = null;
        }
    </script>

    <style>
        /* Custom Styles for Dark Mode and Typography */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #c9d1d9; /* Light text */
        }
        .timeline-container {
            border-left: 2px solid #30363d; /* Dark timeline line */
        }
        .text-gradient {
            background-image: linear-gradient(to right, #6EE7B7, #3B82F6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Scrollbar styling for better dark mode experience */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #161b22;
        }
        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }
    </style>
</head>
<body>

<div id="root" class="min-h-screen"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- MOCK DATA WITH EXTERNAL IMAGE URLS (ç”¨æ–¼æ¸¬è©¦å’Œå±•ç¤º) ---
    const mockItineraryData = [
        {
            day: 1,
            date: "10/01 (ä¸‰)",
            city: "å¤§é˜ª (Osaka)",
            imageUrl: 'https://placehold.co/1200x600/3B82F6/FFFFFF?text=Day+1+Osaka',
            events: [
                {
                    id: '1-1',
                    time: '09:00',
                    location: 'é—œè¥¿æ©Ÿå ´ (KIX)',
                    details: 'æŠµé”é—œè¥¿æ©Ÿå ´ï¼Œæ­ä¹˜ Haruka åˆ—è»Šå‰å¾€å¤§é˜ªå¸‚å€ï¼Œå…¥ä½é£¯åº—ã€‚',
                    imageUrl: 'https://placehold.co/400x200/4F46E5/FFFFFF?text=Kansai+Airport',
                    notes: 'å…Œæ› JR Passã€‚',
                },
                {
                    id: '1-2',
                    time: '14:00',
                    location: 'å¤§é˜ªåŸ (Osaka Castle)',
                    details: 'åƒè§€å®å‰çš„æ­·å²åœ°æ¨™ï¼Œå‘¨åœçš„å…¬åœ’åœ¨ç§‹å­£æ™¯è‰²å®œäººã€‚',
                    imageUrl: 'https://placehold.co/400x200/F97316/FFFFFF?text=Osaka+Castle',
                    notes: 'æº–å‚™å¥½èˆ’é©çš„é‹å­ã€‚',
                }
            ]
        },
        {
            day: 2,
            date: "10/02 (å››)",
            city: "äº¬éƒ½ (Kyoto)",
            imageUrl: 'https://placehold.co/1200x600/10B981/FFFFFF?text=Day+2+Kyoto',
            events: [
                {
                    id: '2-1',
                    time: '10:00',
                    location: 'æ¸…æ°´å¯º (Kiyomizu-dera)',
                    details: 'åƒè§€è‘—åçš„æœ¨çµæ§‹å¯ºå»Ÿï¼Œæ¬£è³äº¬éƒ½å…¨æ™¯ã€‚',
                    imageUrl: 'https://placehold.co/400x200/10B981/FFFFFF?text=Kiyomizu+Temple',
                    notes: 'æ—©ä¸Šäººæ½®è¼ƒå°‘ã€‚',
                },
                {
                    id: '2-2',
                    time: '15:00',
                    location: 'ä¼è¦‹ç¨»è·å¤§ç¤¾ (Fushimi Inari)',
                    details: 'æ¢ç´¢æ•¸åƒåº§ç´…è‰²é³¥å±…ï¼Œæ„Ÿå—ç¥ç§˜æ°›åœã€‚',
                    imageUrl: 'https://placehold.co/400x200/FACC15/000000?text=Fushimi+Inari',
                    notes: 'çˆ¬åˆ°å±±é ‚éœ€è¦ç´„ 1.5 å°æ™‚ã€‚',
                }
            ]
        }
    ];
    // --- MOCK DATA END ---

    // Utility function to get user path for Firestore
    const getPath = (userId, collectionName, docId = null) => {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let path = `/artifacts/${appId}/users/${userId}/${collectionName}`;
        if (docId) {
            path += `/${docId}`;
        }
        return path;
    };

    // Utility function to get the current Firebase user ID
    const getUserId = (auth) => {
        return auth?.currentUser?.uid || 'anonymous';
    };

    // --- Gemini API Function: Search for a public image URL ---
    const searchAndSetImage = async (query) => {
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // System instruction guides the model to find a public image link
        const systemPrompt = `ä½ æ˜¯ä¸€å€‹åœ–åƒæœç´¢åŠ©æ‰‹ã€‚ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæä¾›çš„æŸ¥è©¢ï¼Œä½¿ç”¨ Google Search å·¥å…·ï¼Œæ‰¾åˆ°ä¸€å€‹ä»£è¡¨è©²åœ°é»æˆ–äº‹ç‰©çš„å…¬å…±åœ–ç‰‡ URLï¼ˆå¿…é ˆæ˜¯ HTTPS é€£çµï¼‰ã€‚åªè¿”å›è©²åœ–ç‰‡ URLï¼Œä¸è¦åŒ…å«ä»»ä½•é¡å¤–æ–‡å­—ã€è§£é‡‹æˆ– Markdown æ ¼å¼ã€‚å¦‚æœæ‰¾ä¸åˆ°å…¬å…± URLï¼Œå‰‡è¿”å› "NOT_FOUND"ã€‚`;
        const userQuery = `è«‹ç‚ºä»¥ä¸‹åœ°é»æ‰¾åˆ°ä¸€å€‹é«˜å“è³ªçš„å…¬å…±åœ–ç‰‡ HTTPS URL: ${query}`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            // Enable Google Search grounding
            tools: [{ "google_search": {} }], 
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        const maxRetries = 3;
        let delay = 1000;

        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

                if (text && text.startsWith('https://')) {
                    return text; // Return the found URL
                } else if (text === "NOT_FOUND") {
                    return null; // Model explicitly states nothing found
                } else {
                    console.warn("API returned non-URL text:", text);
                    return null;
                }

            } catch (error) {
                // Do not log retries as errors in the console
                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                } else {
                    return null; // Final failure
                }
            }
        }
        return null;
    };


    // --- Component: Event Image with Fallback ---
    const EventImage = ({ src, alt }) => {
        const [imageSrc, setImageSrc] = useState(src);

        // Fallback placeholder image URL (External and robust)
        const fallbackUrl = "https://placehold.co/400x200/94A3B8/FFFFFF?text=Image+Missing";

        const handleError = (e) => {
            // Only set fallback if the current source isn't already the fallback
            if (e.target.src !== fallbackUrl) {
                setImageSrc(fallbackUrl);
                console.warn(`åœ–ç‰‡è¼‰å…¥å¤±æ•—: ${src}, å·²ä½¿ç”¨å‚™ç”¨åœ–ã€‚`);
            }
        };

        useEffect(() => {
            setImageSrc(src);
        }, [src]);

        return (
            <img 
                src={imageSrc} 
                alt={alt} 
                className="w-full h-full object-cover transition duration-300 ease-in-out transform group-hover:scale-[1.02]"
                onError={handleError}
                loading="lazy"
            />
        );
    };

    // --- Component: Timeline Event Card ---
    const TimelineEvent = ({ event, dayIndex, eventIndex, onSelect }) => {
        const defaultImageUrl = 'https://placehold.co/400x200/171717/3B82F6?text=No+Photo';
        const imageUrl = event.imageUrl || defaultImageUrl;
        
        return (
            <div 
                className="group relative bg-[#161b22] p-5 rounded-xl shadow-lg border border-gray-900/50 hover:border-blue-500 transition-all cursor-pointer"
                onClick={() => onSelect({ dayIndex, eventIndex, prevLoc: null })}
            >
                {/* Image Block: Using EventImage component for robustness */}
                <div className="rounded-lg overflow-hidden mb-4 aspect-video">
                    <EventImage src={imageUrl} alt={event.location} />
                </div>
                
                <div className="absolute top-0 left-[-4px] w-1 h-full bg-blue-500 rounded-lg"></div>
                <div className="flex items-center space-x-3">
                    <i className="ph-clock-fill text-blue-400 text-lg"></i>
                    <span className="text-xl font-semibold text-white">{event.time}</span>
                </div>
                <h3 className="text-2xl font-bold mt-2 text-gradient">{event.location}</h3>
                <p className="text-slate-400 mt-1 line-clamp-2">{event.details}</p>
                {event.notes && (
                    <div className="mt-3 text-sm flex items-center text-yellow-400 bg-yellow-900/30 p-2 rounded-lg">
                        <i className="ph-notepad-fill mr-2"></i>
                        {event.notes}
                    </div>
                )}
            </div>
        );
    };

    // --- Component: Event Detail Modal (æ–°å¢è‡ªå‹•å°‹åœ–åŠŸèƒ½) ---
    const EventDetailModal = ({ event, dayIndex, eventIndex, onClose, db, userId }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [tempDetails, setTempDetails] = useState(event.details);
        const [tempNotes, setTempNotes] = useState(event.notes || '');
        const [tempImageUrl, setTempImageUrl] = useState(event.imageUrl || '');
        const [isSearching, setIsSearching] = useState(false); // New state for search loading
        const [searchError, setSearchError] = useState(null); // New state for search error
        const modalRef = useRef(null);

        const defaultImageUrl = 'https://placehold.co/800x400/171717/3B82F6?text=No+Photo';
        const imageUrl = tempImageUrl || event.imageUrl || defaultImageUrl;

        // --- New Function: Handle Image Search ---
        const handleSearchImage = async () => {
            setSearchError(null);
            setIsSearching(true);
            const query = `${event.city} ${event.location} æ™¯é»åœ–ç‰‡`; 
            
            try {
                const resultUrl = await searchAndSetImage(query);
                if (resultUrl) {
                    setTempImageUrl(resultUrl);
                    // Use a custom UI alert instead of native alert
                    alert("æˆåŠŸæ‰¾åˆ°åœ–ç‰‡é€£çµï¼è«‹é»æ“Š 'å„²å­˜è®Šæ›´' ä¾†æ›´æ–°è¡Œç¨‹ã€‚");
                } else {
                    setSearchError("æŠ±æ­‰ï¼Œç„¡æ³•è‡ªå‹•æ‰¾åˆ°è©²æ™¯é»çš„å…¬å…±åœ–ç‰‡é€£çµã€‚è«‹å˜—è©¦æ‰‹å‹•è¼¸å…¥ã€‚");
                }
            } catch (e) {
                setSearchError("åœ–ç‰‡æœç´¢ç™¼ç”ŸéŒ¯èª¤ã€‚");
                console.error("Image search error:", e);
            } finally {
                setIsSearching(false);
            }
        };


        const handleSave = async () => {
            if (!db || !userId) {
                console.error("Firebase is not initialized or user ID is missing.");
                return;
            }

            // Simple validation for the new image URL (must be HTTPS)
            if (tempImageUrl && tempImageUrl !== '' && !tempImageUrl.startsWith('https://')) {
                alert("åœ–ç‰‡é€£çµå¿…é ˆæ˜¯æœ‰æ•ˆçš„ HTTPS ç¶²å€ï¼");
                return;
            }

            try {
                const dayDocId = `day-${dayIndex + 1}`;
                const eventsCollectionPath = getPath(userId, `itineraries/${dayDocId}/events`, event.id);
                const eventDocRef = window.doc(db, eventsCollectionPath); // FIX: Use window.doc
                
                // Construct update payload
                const updatePayload = {
                    details: tempDetails,
                    notes: tempNotes,
                    // Store the new or updated image URL
                    imageUrl: tempImageUrl, 
                };

                await window.setDoc(eventDocRef, updatePayload, { merge: true }); // FIX: Use window.setDoc

                console.log("Event updated successfully!");
                setIsEditing(false);
            } catch (error) {
                console.error("Error updating event:", error);
                // Use a custom UI alert instead of native alert
                alert("æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤ã€‚");
            }
        };

        const handleDelete = async () => {
            if (!db || !userId) {
                console.error("Firebase is not initialized or user ID is missing.");
                return;
            }
            // Use a custom UI confirm instead of native confirm
            if (!window.confirm(`ç¢ºå®šè¦åˆªé™¤äº‹ä»¶ ${event.location} å—ï¼Ÿ`)) return;

            try {
                const dayDocId = `day-${dayIndex + 1}`;
                const eventsCollectionPath = getPath(userId, `itineraries/${dayDocId}/events`, event.id);
                const eventDocRef = window.doc(db, eventsCollectionPath); // FIX: Use window.doc
                await window.deleteDoc(eventDocRef); // FIX: Use window.deleteDoc
                onClose();
            } catch (error) {
                console.error("Error deleting event:", error);
                alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤ã€‚");
            }
        };

        const handleOutsideClick = (e) => {
            if (modalRef.current && !modalRef.current.contains(e.target)) {
                onClose();
            }
        };

        useEffect(() => {
            document.addEventListener('mousedown', handleOutsideClick);
            return () => document.removeEventListener('mousedown', handleOutsideClick);
        }, []);


        return (
            <div className="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 flex justify-center items-center p-4">
                <div ref={modalRef} className="bg-[#161b22] text-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 scale-100 border border-gray-700/50">
                    <header className="p-6 border-b border-gray-700/50 relative">
                        <h2 className="text-3xl font-bold text-gradient">{event.location}</h2>
                        <p className="mt-1 text-slate-400 text-lg">
                            <i className="ph-clock-fill mr-2"></i>{event.time}
                            <span className="ml-4"><i className="ph-map-pin-fill mr-2"></i>{event.location}</span>
                        </p>
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white transition duration-200">
                            <i className="ph-x-circle-fill text-2xl"></i>
                        </button>
                    </header>

                    {/* Image Display */}
                    <div className="h-64 overflow-hidden">
                        {/* Display image using the temporary state for live preview */}
                        <EventImage src={imageUrl} alt={event.location} />
                    </div>

                    <div className="p-6 space-y-4">
                        <div className="flex justify-end space-x-3">
                            {isEditing ? (
                                <>
                                    <button
                                        onClick={() => setIsEditing(false)}
                                        className="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 transition duration-200 text-white font-medium"
                                        disabled={isSearching}
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button
                                        onClick={handleSave}
                                        className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 transition duration-200 text-white font-medium disabled:opacity-50"
                                        disabled={isSearching}
                                    >
                                        å„²å­˜è®Šæ›´
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button
                                        onClick={handleDelete}
                                        className="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-500 transition duration-200 text-white font-medium"
                                    >
                                        <i className="ph-trash-fill mr-1"></i> åˆªé™¤
                                    </button>
                                    <button
                                        onClick={() => setIsEditing(true)}
                                        className="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-500 transition duration-200 text-white font-medium"
                                    >
                                        <i className="ph-pencil-simple-fill mr-1"></i> ç·¨è¼¯
                                    </button>
                                </>
                            )}
                        </div>

                        <h3 className="text-lg font-semibold border-b border-gray-700/50 pb-1 text-white">æ´»å‹•è©³æƒ…</h3>
                        {isEditing ? (
                            <textarea
                                value={tempDetails}
                                onChange={(e) => setTempDetails(e.target.value)}
                                className="w-full p-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:ring-blue-500 focus:border-blue-500"
                                rows="3"
                            />
                        ) : (
                            <p className="text-slate-300 whitespace-pre-wrap">{event.details}</p>
                        )}

                        <h3 className="text-lg font-semibold border-b border-gray-700/50 pb-1 text-white">åœ–ç‰‡èˆ‡ç­†è¨˜</h3>
                        {isEditing ? (
                            <>
                                <label className="text-sm font-medium text-slate-400 block mb-1">æ™¯é»åœ–ç‰‡ (HTTPS URL):</label>
                                <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                    <input
                                        type="text"
                                        placeholder="è¼¸å…¥å¤–éƒ¨åœ–ç‰‡ HTTPS é€£çµ..."
                                        value={tempImageUrl}
                                        onChange={(e) => {
                                            setTempImageUrl(e.target.value);
                                            setSearchError(null); // Clear error when manually typing
                                        }}
                                        className="flex-grow p-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                    <button
                                        onClick={handleSearchImage}
                                        className="flex-shrink-0 px-4 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition duration-200 text-white font-medium flex items-center justify-center disabled:bg-gray-700 disabled:cursor-not-allowed"
                                        disabled={isSearching}
                                    >
                                        {isSearching ? (
                                            <i className="ph-circle-notch-bold animate-spin text-lg mr-2"></i>
                                        ) : (
                                            <i className="ph-magnifying-glass-plus-fill text-lg sm:mr-2"></i>
                                        )}
                                        {isSearching ? 'æœç´¢ä¸­...' : <span className="hidden sm:inline">è‡ªå‹•å°‹åœ–</span>}
                                    </button>
                                </div>
                                {searchError && (
                                    <p className="text-sm text-red-400 mt-2 p-2 bg-red-900/30 rounded-lg flex items-center">
                                        <i className="ph-warning-fill mr-2 text-lg"></i>
                                        {searchError}
                                    </p>
                                )}
                                <label className="text-sm font-medium text-slate-400 block mt-4 mb-1">é¡å¤–ç­†è¨˜:</label>
                                <textarea
                                    value={tempNotes}
                                    onChange={(e) => setTempNotes(e.target.value)}
                                    className="w-full p-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:ring-blue-500 focus:border-blue-500"
                                    rows="2"
                                    placeholder="è¼¸å…¥é¡å¤–ç­†è¨˜..."
                                />
                            </>
                        ) : (
                            <p className="text-slate-300 italic">{event.notes || 'ç„¡é¡å¤–ç­†è¨˜'}</p>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // --- Main App Component (Logic remains the same) ---
    const App = () => {
        const [itineraryData, setItineraryData] = useState([]);
        const [auth, setAuth] = useState(null);
        const [db, setDb] = useState(null);
        const [userId, setUserId] = useState(null);
        const [isLoading, setIsLoading] = useState(true);
        const [selectedEvent, setSelectedEvent] = useState(null);
        const [error, setError] = useState(null);

        // 1. Initialization and Auth Listener
        useEffect(() => {
            if (window.db && window.auth) {
                setDb(window.db);
                setAuth(window.auth);

                // FIX: onAuthStateChanged is now available on window
                const unsubscribe = window.onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                        console.log("Authenticated with UID:", user.uid);
                    } else {
                        // This case should be rare if the initial logic works, but handles sign-out
                        setUserId(getUserId(window.auth));
                    }
                    setIsLoading(false);
                });

                return () => unsubscribe();
            } else {
                // If Firebase fails to initialize, use mock data
                setItineraryData(mockItineraryData);
                setIsLoading(false);
                setError("Firebase é€£ç·šå¤±æ•—ï¼Œé¡¯ç¤ºæœ¬åœ°ç¤ºç¯„æ•¸æ“šã€‚");
            }
        }, []);

        // 2. Data Listener (Runs AFTER Auth is ready)
        useEffect(() => {
            if (!db || !userId || isLoading) return;

            // Fetch the list of day documents (e.g., 'day-1', 'day-2')
            const itineraryRef = window.collection(db, getPath(userId, 'itineraries')); // FIX: Use window.collection

            const unsubscribe = window.onSnapshot(itineraryRef, async (itinerarySnapshot) => { // FIX: Use window.onSnapshot
                const days = [];
                for (const docSnapshot of itinerarySnapshot.docs) {
                    const dayData = docSnapshot.data();
                    const dayDocId = docSnapshot.id;
                    const eventsCollectionRef = window.collection(db, getPath(userId, `itineraries/${dayDocId}/events`)); // FIX: Use window.collection
                    
                    try {
                        const eventsSnapshot = await window.getDocs(eventsCollectionRef); // FIX: Use window.getDocs
                        const events = eventsSnapshot.docs.map(e => ({ id: e.id, ...e.data() }));

                        // Sort events by time
                        events.sort((a, b) => a.time.localeCompare(b.time));

                        days.push({
                            ...dayData,
                            dayDocId: dayDocId,
                            events: events,
                            // Fallback image for day header
                            imageUrl: dayData.imageUrl || 'https://placehold.co/1200x600/171717/FACC15?text=Day+Header'
                        });

                    } catch (e) {
                        console.error(`Error fetching events for ${dayDocId}:`, e);
                    }
                }
                
                // Sort days by day number (e.g., day-1, day-2)
                days.sort((a, b) => {
                    const numA = parseInt(a.dayDocId.split('-')[1]);
                    const numB = parseInt(b.dayDocId.split('-')[1]);
                    return numA - numB;
                });

                // If no data, use mock data as template for user
                if (days.length === 0) {
                    // This block can be used to write initial mock data to Firestore if desired
                    setItineraryData(mockItineraryData); 
                    console.log("No data found. Displaying mock data.");
                } else {
                    setItineraryData(days);
                }

            }, (err) => {
                console.error("Firestore snapshot error:", err);
                setError("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
            });

            return () => unsubscribe();

        }, [db, userId, isLoading]);


        const handleEventSelect = (details) => {
            setSelectedEvent(details);
        };

        const handleCloseModal = () => {
            setSelectedEvent(null);
        };
        
        // --- Render Logic ---

        if (isLoading) {
            return (
                <div className="flex justify-center items-center h-screen">
                    <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500"></div>
                    <p className="ml-4 text-xl text-slate-400">è¼‰å…¥ä¸­...</p>
                </div>
            );
        }

        if (error && itineraryData.length === 0) {
            return (
                <div className="p-8 text-center">
                    <h1 className="text-3xl font-bold text-red-500">é€£ç·šéŒ¯èª¤</h1>
                    <p className="mt-4 text-slate-400">{error}</p>
                    <p className="mt-2 text-slate-400">ç›®å‰é¡¯ç¤ºç¤ºç¯„è¡Œç¨‹ï¼Œè«‹ä¿®æ­£ Firebase é€£ç·šæˆ–æ‰‹å‹•æ–°å¢æ•¸æ“šã€‚</p>
                </div>
            );
        }

        return (
            <div className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                <header className="text-center py-8 mb-8 border-b border-gray-700/50">
                    <h1 className="text-4xl sm:text-5xl font-extrabold text-gradient">
                        <i className="ph-airplane-takeoff-fill mr-3"></i>2025 æ—¥æœ¬é—œè¥¿/å±±é™½ä¹‹æ—…
                    </h1>
                    <p className="mt-3 text-lg text-slate-400">
                        ç‚ºæ‚¨ç²¾å¿ƒè¦åŠƒçš„æ¯æ—¥è¡Œç¨‹æ™‚é–“è»¸ (ç”¨æˆ¶ ID: {userId})
                    </p>
                </header>

                <main>
                    <div className="timeline-container relative pt-4">
                        {itineraryData.map((currentDayData, dayIndex) => (
                            <div key={currentDayData.dayDocId} className="mb-12 pl-12 relative group">
                                {/* Day Header Section */}
                                <div className="absolute left-4 top-[-2px] w-5 h-5 rounded-full bg-blue-600 z-10 border-4 border-[#0d1117] transition-all group-hover:bg-green-500"></div>
                                <div className="bg-[#1e252e] p-4 rounded-xl shadow-xl mb-6 -mt-1 border border-gray-700/50">
                                    <h2 className="text-3xl font-bold text-white mb-1">
                                        Day {currentDayData.day}: {currentDayData.city}
                                    </h2>
                                    <p className="text-blue-400 text-lg font-medium">{currentDayData.date}</p>
                                </div>
                                
                                {/* Image for the Day */}
                                <div className="rounded-xl overflow-hidden mb-6 shadow-2xl border border-gray-700/50">
                                    <EventImage src={currentDayData.imageUrl} alt={`Day ${currentDayData.day} - ${currentDayData.city}`} />
                                </div>

                                {/* Events List for the Day */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {currentDayData.events.map((event, eventIndex) => (
                                        <TimelineEvent 
                                            key={event.id}
                                            event={event}
                                            dayIndex={dayIndex}
                                            eventIndex={eventIndex}
                                            onSelect={handleEventSelect}
                                        />
                                    ))}
                                </div>

                                {/* End of Day Marker */}
                                <div className="mt-8">
                                    <div className="absolute left-4 top-1 w-4 h-4 rounded-full bg-gray-700 z-10 border-4 border-black"></div>
                                     <div className="text-sm text-slate-500 italic">Day {currentDayData.day} çµæŸ â€¢ ä¼‘æ¯å……é›» ğŸ”‹</div>
                                </div>
                            </div>
                        ))}
                    </div>
                </main>

                <footer className="py-8 text-center text-slate-700 text-xs border-t border-gray-900/50 mt-8">
                    <p>Travel Plan 2025 â€¢ Built with Vibe Coding</p>
                    <p>Powered by Google Gemini & Firebase Firestore</p>
                </footer>
                
                {/* Modal Display */}
                {selectedEvent && (
                    <EventDetailModal
                        event={itineraryData[selectedEvent.dayIndex].events[selectedEvent.eventIndex]}
                        dayIndex={selectedEvent.dayIndex}
                        eventIndex={selectedEvent.eventIndex}
                        prevLoc={selectedEvent.prevLoc}
                        onClose={handleCloseModal}
                        db={db}
                        userId={userId}
                    />
                )}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    // Render only after the global firebase object is available
    window.addEventListener('load', () => {
        root.render(<App />);
    });
</script>
</body>
</html>