<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 æ—¥æœ¬é—œè¥¿/å±±é™½ä¹‹æ—… (é«˜ç´šé»‘æš—æ¨¡å¼)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons (Lightweight icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase modules globally for use in the Babel script block
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, onSnapshot, collection, setLogLevel
        };
        // Set log level to debug for Firestore to ensure smooth debugging
        if (typeof setLogLevel !== 'undefined') {
            setLogLevel('Debug');
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #000000; /* Pure Black */
            color: #e2e8f0; /* Slate 200 */
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom Scrollbar for tabs */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .glass-effect {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }
        .timeline-line {
            position: absolute;
            left: 24px;
            top: 20px;
            bottom: -20px;
            width: 2px;
            background-color: #1f2937; /* Gray 800 */
            z-index: 0;
        }
        .last-item .timeline-line {
            display: none;
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .image-overlay {
            background-image: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0.8) 100%);
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    const { useState, useEffect, useCallback, useMemo } = React;

    // --- API Configuration and Utility Functions ---

    const API_MODEL = "gemini-2.5-flash-preview-09-2025";
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=`;
    const API_KEY = ""; // Canvas will provide this

    // åœ–åƒä½”ä½ç¬¦æ˜ å°„ (ç”¨æ–¼æ¯æ—¥ä¸»è¦–è¦ºåœ–)
    const getDayImage = (day) => {
        const imageMap = {
            1: 'https://placehold.co/600x200/581c87/ffffff?text=Himeji+Castle', // å§¬è·¯åŸ
            2: 'https://placehold.co/600x200/dc2626/ffffff?text=Itsukushima+Shrine', // åš´å³¶ç¥ç¤¾
            3: 'https://placehold.co/600x200/059669/ffffff?text=Kurashiki+Canal', // å€‰æ•·ç¾è§€
            4: 'https://placehold.co/600x200/1d4ed8/ffffff?text=Korakuen+Garden', // å²¡å±±å¾Œæ¨‚åœ’
            5: 'https://placehold.co/600x200/14b8a6/ffffff?text=Arashiyama+Bamboo', // åµå±±
            6: 'https://placehold.co/600x200/4f46e5/ffffff?text=Dotonbori+Osaka', // é“é “å €
            7: 'https://placehold.co/600x200/a855f7/ffffff?text=Tsutenkaku+Tower', // é€šå¤©é–£
            8: 'https://placehold.co/600x200/fb923c/ffffff?text=Rinku+Outlets', // è‡¨ç©ºåŸ
        };
        return imageMap[day] || 'https://placehold.co/600x200/475569/ffffff?text=Japan+Trip';
    };

    // æ–°å¢ï¼šæ´»å‹•ç¸®åœ–ä½”ä½ç¬¦æ˜ å°„ (ç”¨æ–¼æ™‚é–“è»¸é …ç›®)
    const getEventThumbnail = (location) => {
        // Hash the location name to select one of a few placeholder styles for variety
        const hash = Array.from(location).reduce((acc, char) => acc + char.charCodeAt(0), 0);
        const placeholders = [
            { text: 'Castle', bg: '14b8a6', fg: '000000' }, // Teal
            { text: 'Food', bg: 'fb923c', fg: 'ffffff' },   // Orange
            { text: 'Shop', bg: 'a855f7', fg: 'ffffff' },   // Purple
            { text: 'Nature', bg: '1d4ed8', fg: 'ffffff' }, // Blue
            { text: 'Temple', bg: 'dc2626', fg: 'ffffff' }, // Red
            { text: 'Transit', bg: '4f46e5', fg: 'ffffff' }, // Indigo
        ];
        const style = placeholders[hash % placeholders.length];
        
        // The image will be 64x64 for a small thumbnail
        return `https://placehold.co/64x64/${style.bg}/${style.fg}?text=${encodeURIComponent(style.text)}`;
    };
    
    /**
     * Executes a fetch request with exponential backoff for resilience.
     */
    const fetchWithBackoff = async (payload, systemPrompt, maxRetries = 5) => {
        let lastError = null;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const fetchUrl = `${API_URL}${API_KEY}`;
                
                const fullPayload = {
                    ...payload,
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    tools: [{ "google_search": {} }],
                };

                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(fullPayload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return {
                        text: candidate.content.parts[0].text,
                        sources: candidate.groundingMetadata?.groundingAttributions || []
                    };
                } else {
                    // Check for potential block reason
                    const safetyRatings = result.candidates?.[0]?.safetyRatings || [];
                    const blockedReason = safetyRatings.some(r => r.probability !== 'NEGLIGIBLE');
                    if (blockedReason) {
                        throw new Error("AIå…§å®¹ç”Ÿæˆå—é™ï¼Œè«‹å˜—è©¦ä¸åŒçš„æŸ¥è©¢ã€‚");
                    }
                    throw new Error("APIå›æ‡‰çµæ§‹ç„¡æ•ˆã€‚");
                }

            } catch (error) {
                lastError = error;
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                     throw new Error(`å˜—è©¦ ${maxRetries} æ¬¡å¾Œç„¡æ³•é€£æ¥åˆ° AI æœå‹™: ${error.message}`);
                }
            }
        }
        throw new Error("æœªçŸ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚");
    };

    // --- Data and Mappings ---

    // è¡Œç¨‹æ•¸æ“š (ä¿æŒä¸è®Š)
    const itineraryData = [
        { day: 1, date: "11/27 (å››)", title: "ç¥æˆ¶èˆ‡å²¡å±±æŠµé”", city: "å§¬è·¯, ç¥æˆ¶, å²¡å±±", events: [
            { time: "00:50", loc: "HKGÂ·é¦™æ¸¯åœ‹éš›æ©Ÿå ´", stay: "01æ™‚00åˆ†", type: "transport" },
            { time: "06:20", loc: "KIXÂ·é—œè¥¿åœ‹éš›æ©Ÿå ´", stay: "01æ™‚00åˆ†", type: "transport" },
            { time: "08:25", loc: "JRä¸‰å®®ç«™", stay: "00æ™‚20åˆ†", type: "transport" },
            { time: "09:02", loc: "æ–°ç¥æˆ¶", stay: "00æ™‚25åˆ†", type: "transport" },
            { time: "09:53", loc: "å§¬è·¯", stay: "00æ™‚00åˆ†", type: "spot" },
            { time: "10:19", loc: "å§¬è·¯åŸ", stay: "01æ™‚30åˆ†", type: "spot" },
            { time: "12:05", loc: "å¥½å¤åœ’", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "12:43", loc: "ç¥æˆ¶ç‰›ä¸²ç‡’ Kushiyaki Kobe beef", stay: "01æ™‚00åˆ†", type: "food" },
            { time: "14:39", loc: "ç¾åˆ©å …å…¬åœ’", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "15:21", loc: "ç¥æˆ¶è‡¨æµ·æ¨‚åœ’ umie", stay: "02æ™‚30åˆ†", type: "shop" },
            { time: "18:07", loc: "JRä¸‰å®®ç«™", stay: "00æ™‚20åˆ†", type: "transport" },
            { time: "19:10", loc: "VIA INN å²¡å±±", stay: "00æ™‚20åˆ†", type: "hotel" },
            { time: "19:41", loc: "æ°¸æ—ºå¤¢æ¨‚åŸ å²¡å±±", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "20:47", loc: "Tan-ya Bizen (Aeon Mall)", stay: "01æ™‚00åˆ†", type: "food" },
            { time: "21:59", loc: "VIA INN å²¡å±±", stay: "01æ™‚00åˆ†", type: "hotel" },
        ] },
        { day: 2, date: "11/28 (äº”)", title: "å®®å³¶èˆ‡å»£å³¶å·¡ç¦®", city: "å®®å³¶, å»£å³¶", events: [
            { time: "06:00", loc: "VIA INN å²¡å±±", stay: "01æ™‚15åˆ†", type: "hotel" },
            { time: "08:30", loc: "å®®å³¶å£", stay: "00æ™‚00åˆ†", type: "transport" },
            { time: "08:33", loc: "JR Miyajima Ferry", stay: "00æ™‚10åˆ†", type: "transport" },
            { time: "09:21", loc: "åš´å³¶ç¥ç¤¾", stay: "02æ™‚00åˆ†", type: "spot" },
            { time: "11:29", loc: "ç´…è‘‰è°·å…¬åœ’", stay: "00æ™‚40åˆ†", type: "spot" },
            { time: "12:47", loc: "JR Miyajima Ferry", stay: "00æ™‚00åˆ†", type: "transport" },
            { time: "13:25", loc: "Takara (å»£å³¶ç‡’)", stay: "01æ™‚00åˆ†", type: "food" },
            { time: "14:36", loc: "å»£å³¶å’Œå¹³ç´€å¿µè³‡æ–™é¤¨", stay: "00æ™‚45åˆ†", type: "spot" },
            { time: "15:24", loc: "å»£å³¶å’Œå¹³ç´€å¿µå…¬åœ’", stay: "00æ™‚25åˆ†", type: "spot" },
            { time: "15:55", loc: "åŸå­å½ˆçˆ†ç‚¸åœ“é ‚å±‹", stay: "00æ™‚25åˆ†", type: "spot" },
            { time: "16:24", loc: "å»£å³¶ç´™é¶´å¡”", stay: "00æ™‚35åˆ†", type: "spot" },
            { time: "17:11", loc: "å»£å³¶åŸ", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "18:06", loc: "BicCamera å»£å³¶ç«™å‰åº—", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "19:31", loc: "åºƒå³¶ç‰¡è £å‡¦ å¤§è¡†é…’å ´ãƒã‚±ãƒ„ ç«‹ç”ºåº—", stay: "01æ™‚00åˆ†", type: "food" },
            { time: "20:54", loc: "å»£å³¶ç«™", stay: "00æ™‚10åˆ†", type: "transport" },
            { time: "21:51", loc: "VIA INN å²¡å±±", stay: "01æ™‚00åˆ†", type: "hotel" },
        ] },
        { day: 3, date: "11/29 (å…­)", title: "å‰å‚™è·¯èˆ‡å€‰æ•·ç¾è§€", city: "å²¡å±±, å€‰æ•·", events: [
            { time: "08:00", loc: "VIA INN å²¡å±±", stay: "01æ™‚30åˆ†", type: "hotel" },
            { time: "09:51", loc: "å‰å‚™æ´¥ç¥ç¤¾", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "10:30", loc: "å‰å‚™æ´¥å½¥ç¥ç¤¾", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "11:15", loc: "å‰µå‘³é­šèœ å²©æ‰‹å·", stay: "00æ™‚45åˆ†", type: "food" },
            { time: "12:18", loc: "é˜¿æ™ºç¥ç¤¾", stay: "01æ™‚00åˆ†", type: "spot" },
            { time: "13:25", loc: "å€‰æ•·ç¾è§€åœ°å€", stay: "01æ™‚00åˆ†", type: "spot" },
            { time: "14:27", loc: "æœ‰é„°åºµ (å¹¸ç¦å¸ƒä¸)", stay: "01æ™‚00åˆ†", type: "food" },
            { time: "15:29", loc: "å€‰æ•·æ¡ƒå­ ç¸½æœ¬åº—", stay: "00æ™‚00åˆ†", type: "food" },
            { time: "15:50", loc: "ä¸‰äº•OUTLETå€‰æ•·", stay: "02æ™‚00åˆ†", type: "shop" },
            { time: "18:16", loc: "å²¡å±±ä¸€ç•ªè¡—", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "19:22", loc: "Hachiya Honcho (ç‡’è‚‰)", stay: "01æ™‚00åˆ†", type: "food" },
            { time: "20:26", loc: "å”å‰è¨¶å¾· å²¡å±±ç«™å‰åº—", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "21:35", loc: "VIA INN å²¡å±±", stay: "01æ™‚00åˆ†", type: "hotel" },
        ] },
        { day: 4, date: "11/30 (æ—¥)", title: "å²¡å±±å¾Œæ¨‚åœ’èˆ‡å°¾é“æ•£ç­–", city: "å²¡å±±, å°¾é“", events: [
            { time: "08:00", loc: "VIA INN å²¡å±±", stay: "00æ™‚45åˆ†", type: "hotel" },
            { time: "09:04", loc: "å²¡å±±åŸ", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "09:40", loc: "å²¡å±±å¾Œæ¨‚åœ’", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "10:37", loc: "400â„ƒ PIZZA (2å·åº—)", stay: "00æ™‚45åˆ†", type: "food" },
            { time: "12:18", loc: "å°¾é“", stay: "00æ™‚10åˆ†", type: "transport" },
            { time: "12:32", loc: "é§…å‰å•†åº—è¡— ãŠã®ã¿ã¡", stay: "00æ™‚15åˆ†", type: "shop" },
            { time: "12:51", loc: "Uminomieru Park", stay: "00æ™‚20åˆ†", type: "spot" },
            { time: "13:14", loc: "Karasawa Ice Cream", stay: "00æ™‚25åˆ†", type: "food" },
            { time: "13:50", loc: "åƒå…‰å¯ºå±±çºœè»Š å±±éº“ç«™", stay: "00æ™‚10åˆ†", type: "transport" },
            { time: "14:15", loc: "åƒå…‰å¯ºå±±çºœè»Š (ç§»å‹•)", stay: "00æ™‚00åˆ†", type: "transport" },
            { time: "14:16", loc: "åƒå…‰å¯ºå…¬åœ’é ‚ä¸Šå±•æœ›å°", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "14:50", loc: "åƒå…‰å¯º", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "15:23", loc: "é¼“å²©", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "16:08", loc: "è²“ä¹‹ç´°é“", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "16:46", loc: "å°¾é“æ‹‰éºµ å£¹ç•ªé¤¨æœ¬åº—", stay: "01æ™‚00åˆ†", type: "food" },
            { time: "17:57", loc: "æŒå…‰å¯ºå‚é“", stay: "00æ™‚15åˆ†", type: "spot" },
            { time: "18:14", loc: "å°¾é“æœ¬é€šå•†åº—è¡—", stay: "00æ™‚30åˆ†", type: "shop" },
            { time: "19:27", loc: "VIA INN å²¡å±±", stay: "01æ™‚00åˆ†", type: "hotel" },
        ] },
        { day: 5, date: "12/01 (ä¸€)", title: "åµå±±é¢¨æƒ…èˆ‡ç§»å‹•è‡³å¤§é˜ª", city: "äº¬éƒ½, å¤§é˜ª", events: [
            { time: "08:00", loc: "VIA INN å²¡å±±", stay: "01æ™‚30åˆ†", type: "hotel" },
            { time: "10:24", loc: "æ–°å¤§é˜ª", stay: "00æ™‚30åˆ†", type: "transport" },
            { time: "11:43", loc: "JRåµ¯å³¨åµå±±ç«™", stay: "00æ™‚00åˆ†", type: "transport" },
            { time: "11:58", loc: "åµå±±ç«¹æ—å°å¾‘", stay: "01æ™‚00åˆ†", type: "spot" },
            { time: "13:11", loc: "è•éº¥éºµ åµå±±ã‚ˆã—ã‚€ã‚‰", stay: "01æ™‚00åˆ†", type: "food" },
            { time: "14:17", loc: "Wagyu Volcano OAGARI", stay: "00æ™‚00åˆ†", type: "food" },
            { time: "14:23", loc: "æ¸¡æœˆæ©‹", stay: "01æ™‚00åˆ†", type: "spot" },
            { time: "15:59", loc: "äº¬éƒ½å…«å‚ç¥ç¤¾", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "16:52", loc: "äº¬éƒ½ç«™", stay: "00æ™‚10åˆ†", type: "transport" },
            { time: "17:40", loc: "æ–°å¤§é˜ª", stay: "00æ™‚15åˆ†", type: "transport" },
            { time: "18:19", loc: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", stay: "00æ™‚35åˆ†", type: "hotel" },
            { time: "19:13", loc: "æ¾å³¶æ–°åœ°", stay: "01æ™‚00åˆ†", type: "spot" },
            { time: "20:32", loc: "é“é “å €", stay: "01æ™‚00åˆ†", type: "spot" },
            { time: "21:35", loc: "å”å‰è¨¶å¾· é“é “å €å¾¡å ‚ç­‹åº—", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "22:37", loc: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", stay: "01æ™‚00åˆ†", type: "hotel" },
        ] },
        { day: 6, date: "12/02 (äºŒ)", title: "å¤§é˜ªå¸‚å€è³¼ç‰©æ—¥", city: "å¤§é˜ª", events: [
            { time: "08:00", loc: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", stay: "02æ™‚20åˆ†", type: "hotel" },
            { time: "10:31", loc: "é«˜å³¶å±‹ å¤§é˜ªåº—", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "11:36", loc: "é›£æ³¢ä¸¸äº• (0101)", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "12:52", loc: "ç¾åœ‹æ‘", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "14:10", loc: "LUCUA 1100", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "15:18", loc: "é˜ªæ€¥ç™¾è²¨ æ¢…ç”°ç¸½åº—", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "16:21", loc: "æ–°æ¢…ç”°ç¾é£Ÿè¡—", stay: "01æ™‚00åˆ†", type: "food" },
            { time: "17:26", loc: "LINKS UMEDA", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "18:29", loc: "Luck Rack LINKS UMEDA", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "19:34", loc: "GRAND FRONT å¤§é˜ª åŒ—é¤¨", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "20:58", loc: "å¿ƒé½‹æ©‹", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "22:13", loc: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", stay: "01æ™‚00åˆ†", type: "hotel" },
        ] },
        { day: 7, date: "12/03 (ä¸‰)", title: "å¤§é˜ªæ–‡åŒ–èˆ‡æ–°ä¸–ç•Œ", city: "å¤§é˜ª", events: [
            { time: "08:00", loc: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", stay: "02æ™‚30åˆ†", type: "hotel" },
            { time: "11:08", loc: "æ˜¥é§’å£½å¸ æœ¬åº—", stay: "01æ™‚00åˆ†", type: "food" },
            { time: "12:29", loc: "å¤©ç¥æ©‹ç­‹å•†åº—è¡—", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "13:52", loc: "å››å¤©ç‹å¯º", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "14:32", loc: "å €è¶Šç¥ç¤¾", stay: "00æ™‚30åˆ†", type: "spot" },
            { time: "15:20", loc: "é£›ç”°æ–°åœ°", stay: "01æ™‚00åˆ†", type: "spot" },
            { time: "16:29", loc: "é€šå¤©é–£", stay: "01æ™‚00åˆ†", type: "spot" },
            { time: "17:32", loc: "æ–°ä¸–ç•Œå¸‚å ´", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "18:52", loc: "å¤©ç‹å¯ºå…¬åœ’", stay: "02æ™‚00åˆ†", type: "spot" },
            { time: "21:15", loc: "å”å‰è¨¶å¾· é›£æ³¢åƒæ—¥å‰åº—", stay: "01æ™‚00åˆ†", type: "shop" },
            { time: "22:27", loc: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", stay: "01æ™‚00åˆ†", type: "hotel" },
        ] },
        { day: 8, date: "12/04 (å››)", title: "è‡¨ç©ºåŸ Outlet èˆ‡è¿”ç¨‹", city: "å¤§é˜ª", events: [
            { time: "08:00", loc: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", stay: "03æ™‚00åˆ†", type: "hotel" },
            { time: "11:57", loc: "è‡¨ç©ºåŸç«™", stay: "00æ™‚00åˆ†", type: "transport" },
            { time: "12:10", loc: "è‡¨ç©º Premium Outlets", stay: "02æ™‚35åˆ†", type: "shop" },
            { time: "14:58", loc: "è‡¨ç©ºåŸç«™", stay: "00æ™‚10åˆ†", type: "transport" },
            { time: "15:38", loc: "KIXÂ·é—œè¥¿åœ‹éš›æ©Ÿå ´", stay: "02æ™‚27åˆ†", type: "transport" },
            { time: "22:35", loc: "HKGÂ·é¦™æ¸¯åœ‹éš›æ©Ÿå ´", stay: "END", type: "transport" },
        ] }
    ];

    // åœ–ç¤ºçµ„ä»¶æ˜ å°„
    const getIcon = (type) => {
        switch(type) {
            case 'transport': return <i className="ph-fill ph-train text-white"></i>;
            case 'food': return <i className="ph-fill ph-bowl-food text-white"></i>;
            case 'hotel': return <i className="ph-fill ph-bed text-white"></i>;
            case 'shop': return <i className="ph-fill ph-shopping-bag text-white"></i>;
            default: return <i className="ph-fill ph-camera text-white"></i>;
        }
    };

    // é¡è‰²æ˜ å°„ (èª¿æ•´å¾—æ›´äº®ä¸€é»ä»¥é©æ‡‰æ·±è‰²èƒŒæ™¯)
    const getColor = (type) => {
        switch(type) {
            case 'transport': return 'bg-blue-600 ring-2 ring-blue-900';
            case 'food': return 'bg-orange-500 ring-2 ring-orange-900';
            case 'hotel': return 'bg-indigo-600 ring-2 ring-indigo-900';
            case 'shop': return 'bg-pink-600 ring-2 ring-pink-900';
            default: return 'bg-emerald-600 ring-2 ring-emerald-900'; // spot
        }
    };

    // --- Loading/Error Components ---
    const LoadingSpinner = () => (
        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    );
    
    // --- Event Detail Modal Component ---
    
    const EventDetailModal = ({ 
        event, 
        dayIndex,
        eventIndex,
        prevLoc, 
        onClose, 
        db, 
        userId 
    }) => {
        
        const [description, setDescription] = useState(null);
        const [descLoading, setDescLoading] = useState(false);
        const [descError, setDescError] = useState(null);

        const [userRemark, setUserRemark] = useState('');
        const [remarkLoading, setRemarkLoading] = useState(false);

        const [routeState, setRouteState] = useState({ loading: false, details: null, error: null });

        // 1. Fetch Introduction/Description
        const fetchIntroduction = useCallback(async (locationName) => {
            setDescLoading(true);
            setDescError(null);
            const userQuery = `è«‹æä¾›æ—¥æœ¬æ™¯é» "${locationName}" çš„ç°¡æ½”ä¸­æ–‡ç°¡ä»‹ã€‚`;
            const systemPrompt = "ä½ æ˜¯ä¸€ä½ç²¾é€šæ—¥æœ¬æ–‡åŒ–èˆ‡æ—…éŠçš„å°ˆå®¶ã€‚è«‹ç‚ºç”¨æˆ¶æä¾›çš„åœ°é»ï¼Œæä¾›ä¸€æ®µç°¡æ½”ã€å¸å¼•äººçš„ä¸­æ–‡ç°¡ä»‹ï¼ˆç´„3-4å¥è©±ï¼‰ã€‚åƒ…æä¾›ç°¡ä»‹æ–‡å­—ï¼Œä¸åŒ…å«æ¨™é¡Œæˆ–é¡å¤–èªªæ˜ã€‚";

            try {
                const payload = { contents: [{ parts: [{ text: userQuery }] }] };
                const { text } = await fetchWithBackoff(payload, systemPrompt);
                setDescription(text);
            } catch (error) {
                setDescError(error.message);
            } finally {
                setDescLoading(false);
            }
        }, []);

        // 2. Route Fetching Logic
        const fetchRoute = async (fromLoc, toLoc) => {
            setRouteState({ loading: true, details: null, error: null });

            const userQuery = `è«‹æä¾›å¾ ${fromLoc} åˆ° ${toLoc} çš„æœ€ä½³ä¹˜è»Š/äº¤é€šè·¯ç·šï¼ŒåŒ…æ‹¬é è¨ˆæ™‚é–“å’Œæ›ä¹˜è³‡è¨Šã€‚`;
            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆé–€æä¾›æ—¥æœ¬äº¤é€šè·¯ç·šè¦åŠƒçš„å°ˆå®¶ã€‚è«‹æ ¹æ“šæœ€æ–°çš„ç¶²è·¯è³‡è¨Šï¼Œç‚ºçµ¦å®šçš„èµ·é»å’Œçµ‚é»æä¾›æœ€å¿«é€Ÿæˆ–æœ€æ–¹ä¾¿çš„äº¤é€šè·¯ç·šã€‚è«‹ä»¥ä¸­æ–‡(ç¹é«”)æ¢åˆ—å¼æˆ–æ®µè½å½¢å¼ï¼Œæ¸…æ™°åœ°èªªæ˜äº¤é€šæ–¹å¼ï¼ˆä¾‹å¦‚ï¼šJRæ–°å¹¹ç·šã€å·´å£«ã€åœ°éµï¼‰ã€é è¨ˆæ‰€éœ€æ™‚é–“å’Œé—œéµçš„æ›ä¹˜é»ã€‚ä¸è¦åŒ…å«åœ°åœ–éˆæ¥æˆ–å¤–éƒ¨URLã€‚";

            try {
                const payload = { contents: [{ parts: [{ text: userQuery }] }] };
                const { text } = await fetchWithBackoff(payload, systemPrompt);
                setRouteState({ loading: false, details: text, error: null });
            } catch (error) {
                setRouteState({ loading: false, details: null, error: error.message });
            }
        };

        // 3. Firebase Remark Persistence
        const remarkDocPath = `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/trip_remarks/${dayIndex}-${eventIndex}`;
        const remarkDocRef = db ? window.firebase.doc(db, remarkDocPath) : null;
        
        // Load remark on mount
        useEffect(() => {
            if (event.loc) {
                fetchIntroduction(event.loc);
            }
            
            if (remarkDocRef) {
                // Real-time listener for the remark
                const unsubscribe = window.firebase.onSnapshot(remarkDocRef, (doc) => {
                    if (doc.exists()) {
                        setUserRemark(doc.data().text || '');
                    } else {
                        setUserRemark('');
                    }
                }, (error) => {
                    console.error("Error listening to remark:", error);
                });
                return () => unsubscribe();
            }
        }, [event.loc, fetchIntroduction, remarkDocRef]);

        // Save remark to Firestore
        const handleSaveRemark = async (e) => {
            e.preventDefault();
            if (!remarkDocRef || remarkLoading) return;
            setRemarkLoading(true);
            try {
                const data = {
                    text: userRemark,
                    updatedAt: new Date().toISOString(),
                    location: event.loc,
                    day: dayIndex + 1
                };
                await window.firebase.setDoc(remarkDocRef, data, { merge: true });
                // Success is handled by onSnapshot
            } catch (error) {
                alert("å‚™è¨»å„²å­˜å¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„é€£ç·šã€‚");
                console.error("Saving remark failed:", error);
            } finally {
                setRemarkLoading(false);
            }
        };

        return (
            <div className="fixed inset-0 z-50 overflow-y-auto bg-black/95 animate-slide-up" onClick={onClose}>
                <div className="max-w-md mx-auto min-h-full flex flex-col pt-0" onClick={(e) => e.stopPropagation()}>
                    
                    {/* Image Header */}
                    <div className="relative h-48 w-full">
                        <img 
                            src={getDayImage(dayIndex + 1)} 
                            alt={event.loc} 
                            className="w-full h-full object-cover"
                            onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/600x200/475569/ffffff?text=Image+Load+Error"; }}
                        />
                        <div className="image-overlay absolute inset-0"></div>
                        <div className="absolute bottom-4 left-4 right-4 z-10">
                            <h2 className="text-3xl font-extrabold text-white drop-shadow-lg leading-tight">
                                {event.loc}
                            </h2>
                            <p className="text-sm font-medium text-blue-300 mt-1 flex items-center gap-2">
                                <span className={getColor(event.type).split(' ')[0] + ' p-1 rounded-md'}>{getIcon(event.type)}</span>
                                {event.time} â€¢ åœç•™ {event.stay}
                            </p>
                        </div>
                    </div>
                    
                    {/* Content Body */}
                    <div className="flex-grow bg-[#000000] p-5 rounded-t-3xl -mt-5 shadow-2xl shadow-black/80 space-y-6">
                        
                        {/* é—œé–‰æŒ‰éˆ• */}
                        <button 
                            onClick={onClose} 
                            className="absolute top-2 right-2 text-white bg-white/10 hover:bg-white/20 p-2 rounded-full transition-colors"
                        >
                            <i className="ph-bold ph-x text-xl"></i>
                        </button>

                        {/* 1. æ™¯é»ç°¡ä»‹ */}
                        <div className="bg-gray-900 p-4 rounded-xl border border-gray-800 shadow-xl">
                            <h3 className="text-xl font-bold text-white mb-3 flex items-center">
                                <i className="ph-fill ph-sparkle text-yellow-400 mr-2"></i> æ™¯é»ç°¡ä»‹
                            </h3>
                            {descLoading ? (
                                <div className="flex items-center text-blue-400">
                                    <LoadingSpinner /> æ­£åœ¨ç”Ÿæˆç°¡ä»‹...
                                </div>
                            ) : descError ? (
                                <p className="text-sm text-red-400 italic">ç°¡ä»‹è¼‰å…¥å¤±æ•—: {descError}</p>
                            ) : (
                                <p className="text-gray-300 whitespace-pre-wrap leading-relaxed text-sm">
                                    {description || 'æ‰¾ä¸åˆ°è©²åœ°é»çš„ç°¡ä»‹ã€‚'}
                                </p>
                            )}
                        </div>

                        {/* 2. ä¹˜è»Šè·¯ç·š (åƒ…é™äº¤é€šäº‹ä»¶æˆ–æœ‰å‰ä¸€å€‹åœ°é»æ™‚) */}
                        {(event.type === 'transport' || prevLoc !== 'è¡Œç¨‹èµ·é»') && (
                            <div className="bg-gray-900 p-4 rounded-xl border border-gray-800 shadow-xl">
                                <h3 className="text-xl font-bold text-white mb-3 flex items-center">
                                    <i className="ph-fill ph-map-pin-line text-blue-400 mr-2"></i> äº¤é€š/è·¯ç·šæŸ¥è©¢
                                </h3>
                                {prevLoc === 'è¡Œç¨‹èµ·é»' ? (
                                    <p className="text-sm text-gray-400">é€™æ˜¯æ‚¨è¡Œç¨‹çš„ç¬¬ä¸€ç«™ï¼Œè«‹è‡ªè¡Œè¦åŠƒå¾ä½å®¿åœ°é»å‡ºç™¼çš„è·¯ç·šã€‚</p>
                                ) : (
                                    <>
                                        <p className="text-sm text-gray-400 mb-3">å¾ **{prevLoc}** å‡ºç™¼ï¼Œå‰å¾€ **{event.loc}**ã€‚</p>
                                        <button
                                            onClick={() => fetchRoute(prevLoc, event.loc)}
                                            disabled={routeState.loading}
                                            className="w-full py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50
                                            bg-blue-600 text-white hover:bg-blue-700 active:scale-[0.99] flex items-center justify-center"
                                        >
                                            {routeState.loading ? <><LoadingSpinner /> æ­£åœ¨æŸ¥è©¢è·¯ç·š...</> : 'é»æ“ŠæŸ¥è©¢ä¹˜è»Šè·¯ç·š'}
                                        </button>

                                        {routeState.error && (
                                            <p className="text-sm text-red-400 mt-3 text-center">è·¯ç·šæŸ¥è©¢å¤±æ•—: {routeState.error}</p>
                                        )}

                                        {routeState.details && (
                                            <div className="mt-3 p-3 bg-gray-800 rounded-lg whitespace-pre-wrap text-xs text-gray-300 border border-gray-700">
                                                {routeState.details}
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        )}
                        
                        {/* 3. æ‚¨çš„å‚™è¨» */}
                        <form onSubmit={handleSaveRemark} className="bg-gray-900 p-4 rounded-xl border border-gray-800 shadow-xl">
                            <h3 className="text-xl font-bold text-white mb-3 flex items-center">
                                <i className="ph-fill ph-note-pencil text-indigo-400 mr-2"></i> æ‚¨çš„å‚™è¨»
                            </h3>
                            <textarea
                                value={userRemark}
                                onChange={(e) => setUserRemark(e.target.value)}
                                placeholder="åœ¨é€™è£¡å¯«ä¸‹æ‚¨çš„ç­†è¨˜ã€å¿ƒå¾—æˆ–æ³¨æ„äº‹é …..."
                                rows="4"
                                className="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                            ></textarea>
                            <button
                                type="submit"
                                disabled={remarkLoading}
                                className="w-full mt-3 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50
                                bg-indigo-600 text-white hover:bg-indigo-700 active:scale-[0.99] flex items-center justify-center"
                            >
                                {remarkLoading ? <><LoadingSpinner /> æ­£åœ¨å„²å­˜...</> : 'å„²å­˜å‚™è¨»åˆ°é›²ç«¯'}
                            </button>
                            <p className="text-xs text-gray-500 mt-2 text-center">å‚™è¨»æœƒè‡ªå‹•å„²å­˜åœ¨æ‚¨çš„å¸³æˆ¶ä¸­ã€‚</p>
                        </form>
                    </div>
                </div>
            </div>
        );
    };

    // --- Main App Component ---

    const App = () => {
        const [activeDay, setActiveDay] = useState(0);
        const [dailyWeather, setDailyWeather] = useState({ loading: false, data: null, error: null });
        const [isAuthReady, setIsAuthReady] = useState(false);
        
        // Firebase State
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [userId, setUserId] = useState(null);

        // Modal State
        const [selectedEvent, setSelectedEvent] = useState(null); // { dayIndex, eventIndex, prevLoc }

        const currentDayData = itineraryData[activeDay];

        // 1. Firebase Initialization and Authentication
        useEffect(() => {
            const initFirebase = async () => {
                if (!window.firebase) {
                    console.error("Firebase library not loaded.");
                    return;
                }

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing API key.");
                    setIsAuthReady(true); // Allow non-db functionality
                    return;
                }

                try {
                    const app = window.firebase.initializeApp(firebaseConfig, appId);
                    const authInstance = window.firebase.getAuth(app);
                    const dbInstance = window.firebase.getFirestore(app);
                    
                    setAuth(authInstance);
                    setDb(dbInstance);

                    // Authentication
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    
                    if (initialAuthToken) {
                        await window.firebase.signInWithCustomToken(authInstance, initialAuthToken);
                    } else {
                        await window.firebase.signInAnonymously(authInstance);
                    }

                    window.firebase.onAuthStateChanged(authInstance, (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            // Should not happen after sign-in, but as fallback
                            setUserId(crypto.randomUUID());
                        }
                        setIsAuthReady(true);
                    });

                } catch (error) {
                    console.error("Firebase initialization or sign-in failed:", error);
                    setIsAuthReady(true); // Proceed without persistence
                }
            };
            initFirebase();
        }, []);


        // 2. Fetch Weather Data (Same as previous version, but now uses auth check)
        const fetchWeather = useCallback(async (dayData) => {
            if (!dayData.city || dailyWeather.loading || !isAuthReady) return;

            setDailyWeather({ loading: true, data: null, error: null });
            const city = dayData.city.split(',')[0].trim(); // Use the first city for the main weather
            const date = dayData.date.split(' ')[0];

            const userQuery = `è«‹æä¾›æ—¥æœ¬åŸå¸‚ ${city} åœ¨ ${date} çš„å¤©æ°£é å ±ã€æœ€é«˜æº«å’Œæœ€ä½æº«ã€‚`;
            const systemPrompt = "ä½ æ˜¯ä¸€ä½ç²¾ç¢ºçš„æ°£è±¡æ’­å ±å“¡ï¼Œæ ¹æ“šæœ€æ–°çš„ç¶²è·¯è³‡è¨Šï¼Œç‚ºæ—¥æœ¬ç‰¹å®šåŸå¸‚å’Œæ—¥æœŸæä¾›å¤©æ°£é å ±ã€‚è«‹ç”¨ä¸­æ–‡(ç¹é«”)ç°¡æ½”åœ°ç¸½çµå¤©æ°£ç‹€æ³ã€é è¨ˆæº«åº¦ç¯„åœï¼ˆæœ€é«˜/æœ€ä½ï¼‰ã€‚ä¾‹å¦‚ï¼š'11æœˆ27æ—¥ç¥æˆ¶çš„å¤©æ°£é è¨ˆç‚ºæ™´æ™‚å¤šé›²ï¼Œæ°£æº«ä»‹æ–¼æ”æ°9åº¦è‡³15åº¦ä¹‹é–“ï¼Œå»ºè­°æ”œå¸¶è¼•ä¾¿å¤–å¥—ã€‚'å¦‚æœæ‰¾ä¸åˆ°ç‰¹å®šæ—¥æœŸçš„é å ±ï¼Œè«‹æä¾›ç•¶å‰é å ±ä¸¦èªªæ˜ã€‚";

            try {
                const payload = { contents: [{ parts: [{ text: userQuery }] }] };
                const { text } = await fetchWithBackoff(payload, systemPrompt);
                setDailyWeather({ loading: false, data: text, error: null });
            } catch (error) {
                setDailyWeather({ loading: false, data: null, error: error.message });
            }
        }, [dailyWeather.loading, isAuthReady]);

        // 3. Effect for Weather Fetching
        useEffect(() => {
            if (isAuthReady) {
                fetchWeather(currentDayData);
            }
        }, [activeDay, currentDayData, fetchWeather, isAuthReady]);
        
        // 4. Load Remarks for current day (for displaying the checkmark)
        const [currentDayRemarks, setCurrentDayRemarks] = useState({});

        useEffect(() => {
            if (!db || !userId) return;

            const collectionPath = `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/users/${userId}/trip_remarks`;
            const q = window.firebase.collection(db, collectionPath);
            
            // Only listen to remarks for the current day for efficiency
            const dayKey = (activeDay + 1).toString();
            
            const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                const remarks = {};
                snapshot.forEach(doc => {
                    const id = doc.id; // Format: 'dayIndex-eventIndex'
                    const data = doc.data();
                    if (data.day === activeDay + 1 && data.text) {
                       remarks[id] = data.text;
                    }
                });
                setCurrentDayRemarks(remarks);
            }, (error) => {
                console.error("Error fetching day remarks:", error);
            });

            return () => unsubscribe();
        }, [db, userId, activeDay]);


        // --- Component Helper Functions ---

        // Open Map Helper
        const openMap = (loc) => {
            const query = encodeURIComponent(loc);
            window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
        };
        
        // Open Modal
        const handleOpenModal = (dayIndex, eventIndex, prevLoc) => {
            setSelectedEvent({ dayIndex, eventIndex, prevLoc });
        };
        
        // Close Modal
        const handleCloseModal = () => {
            setSelectedEvent(null);
        };
        
        const LoadingSpinner = () => (
            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );

        const WeatherDisplay = ({ city, date, weather, loading, error }) => {
            if (loading) {
                return (
                    <div className="flex items-center text-sm text-blue-400 p-3 rounded-xl bg-gray-900 border border-gray-800 mt-4 shadow-md">
                        <LoadingSpinner /> æ­£åœ¨æŸ¥è©¢ {city} çš„å¤©æ°£...
                    </div>
                );
            }
            if (error) {
                return (
                    <div className="flex items-center text-sm text-red-400 p-3 rounded-xl bg-red-900/30 border border-red-700/50 mt-4 shadow-md">
                        <i className="ph-fill ph-warning-circle mr-2"></i> å¤©æ°£æŸ¥è©¢å¤±æ•—: {error}
                    </div>
                );
            }
            if (weather) {
                return (
                    <div className="text-sm text-slate-300 p-3 rounded-xl bg-gray-900 border border-gray-800 mt-4 shadow-xl">
                        <div className="flex items-center mb-1 text-base font-semibold text-white">
                            <i className="ph-fill ph-cloud-lightning mr-2 text-yellow-400 text-lg"></i>
                            {date.split(' ')[0]} {city} å¤©æ°£é å ±
                        </div>
                        <p className="text-slate-400 leading-relaxed text-sm whitespace-pre-wrap">{weather}</p>
                    </div>
                );
            }
            return null;
        };


        return (
            <div className="max-w-md mx-auto min-h-screen bg-black pb-safe">
                
                {/* Header */}
                <header className="sticky top-0 z-50 glass-effect border-b border-gray-900 shadow-xl shadow-black/80">
                    <div className="px-5 py-4">
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl font-bold text-slate-100 tracking-tight">ğŸ‡¯ğŸ‡µ 2025 é—œè¥¿/å±±é™½ä¹‹æ—…</h1>
                            <span className="text-xs font-medium bg-blue-600 text-white px-2 py-1 rounded-full shadow-lg shadow-blue-500/30">
                                {itineraryData.length} Days
                            </span>
                        </div>
                        <p className="text-xs text-slate-400 mt-1">11/27 - 12/04 â€¢ é¦™æ¸¯ / æ—¥æœ¬</p>
                         <p className="text-xs text-slate-600 mt-1">User ID: {isAuthReady ? (userId || 'N/A') : 'Loading...'}</p>
                    </div>

                    {/* Day Tabs */}
                    <div className="flex overflow-x-auto px-4 pb-3 gap-3 hide-scrollbar snap-x">
                        {itineraryData.map((day, index) => (
                            <button
                                key={index}
                                onClick={() => setActiveDay(index)}
                                className={`flex-shrink-0 snap-start px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 border ${
                                    activeDay === index
                                    ? 'bg-blue-600 text-white border-blue-500 shadow-lg shadow-blue-500/20 transform scale-105'
                                    : 'bg-gray-800 text-slate-400 border-gray-700 hover:border-gray-600 hover:bg-gray-700'
                                }`}
                            >
                                <div className="text-xs opacity-80">Day {day.day}</div>
                                <div>{day.date.split(' ')[0]}</div>
                            </button>
                        ))}
                        <div className="w-2 flex-shrink-0"></div> {/* Spacer */}
                    </div>
                </header>

                {/* Content */}
                <main className="pb-6">
                    
                    {/* Hero Image */}
                    <div className="relative w-full h-48 mb-6 overflow-hidden shadow-lg shadow-black/50">
                        <img 
                            src={getDayImage(currentDayData.day)} 
                            alt={currentDayData.title} 
                            className="w-full h-full object-cover transition-transform duration-500 hover:scale-105"
                            onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/600x200/475569/ffffff?text=Image+Load+Error"; }}
                        />
                        <div className="image-overlay absolute inset-0"></div>
                        <div className="absolute bottom-4 left-5 right-5 z-10 animate-fade-in">
                            <h2 className="text-3xl font-extrabold text-white drop-shadow-lg leading-tight">{currentDayData.title}</h2>
                            <div className="flex items-center gap-2 mt-1 text-sm text-blue-300 font-medium">
                                <i className="ph ph-calendar-blank"></i>
                                <span>{currentDayData.date}</span>
                            </div>
                        </div>
                    </div>
                    
                    {/* Day Info and Weather */}
                    <div className="px-5">
                        <WeatherDisplay 
                            city={currentDayData.city.split(',')[0].trim()}
                            date={currentDayData.date}
                            weather={dailyWeather.data}
                            loading={dailyWeather.loading}
                            error={dailyWeather.error}
                        />
                    </div>
                    

                    {/* Timeline */}
                    <div className="relative space-y-0 px-5 mt-6">
                        {currentDayData.events.map((event, index) => {
                            const isLast = index === currentDayData.events.length - 1;
                            const previousEvent = index > 0 ? currentDayData.events[index - 1] : { loc: 'è¡Œç¨‹èµ·é»' };
                            const eventKey = `${activeDay}-${index}`;
                            const hasRemark = currentDayRemarks.hasOwnProperty(eventKey);
                            
                            return (
                                <div 
                                    key={index} 
                                    className={`relative pl-12 pb-8 ${isLast ? 'last-item' : ''}`}
                                >
                                    {/* Vertical Line */}
                                    <div className="timeline-line"></div>

                                    {/* Icon Dot */}
                                    <div 
                                        className={`absolute left-0 top-1 w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg shadow-black/20 z-10 border-4 border-black ${getColor(event.type)}`}
                                    >
                                        <div className="text-lg flex">
                                            {getIcon(event.type)}
                                        </div>
                                    </div>

                                    {/* Card */}
                                    <div 
                                        onClick={() => handleOpenModal(activeDay, index, previousEvent.loc)}
                                        className="bg-gray-900 p-4 rounded-2xl border border-gray-800 shadow-xl cursor-pointer active:scale-[0.99] transition-all group hover:border-blue-500/50 flex gap-4 items-center"
                                    >
                                        {/* ç¸®åœ–é è¦½ */}
                                        <img 
                                            src={getEventThumbnail(event.loc)}
                                            alt={event.loc}
                                            className="w-16 h-16 object-cover rounded-lg flex-shrink-0 border border-gray-700 shadow-lg"
                                            onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/64x64/334155/ffffff?text=X"; }}
                                        />

                                        <div className="flex-grow min-w-0">
                                            <div className="flex justify-between items-start mb-2">
                                                <span className="inline-flex items-center justify-center bg-gray-800 text-slate-200 text-xs font-bold px-2 py-1 rounded-md font-mono border border-gray-700">
                                                    {event.time}
                                                </span>
                                                <div className="flex items-center gap-2">
                                                    {hasRemark && (
                                                        <i className="ph-fill ph-note-pencil text-indigo-400 text-sm" title="æ‚¨æœ‰å‚™è¨»"></i>
                                                    )}
                                                    {event.stay !== "END" && (
                                                         <span className="flex items-center text-[10px] text-slate-400 font-medium">
                                                            <i className="ph-fill ph-hourglass mr-1"></i>
                                                            {event.stay}
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            <h3 className="text-lg font-bold text-slate-100 leading-tight group-hover:text-blue-400 transition-colors truncate">
                                                {event.loc}
                                            </h3>
                                            
                                            <div className="mt-1 flex items-center text-xs text-slate-500">
                                                <span className="flex items-center gap-1 group-hover:text-blue-400 transition-colors font-medium">
                                                    <i className="ph-bold ph-info"></i>
                                                    é»æ“ŠæŸ¥çœ‹è©³æƒ…èˆ‡å‚™è¨»
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        
                        {/* End of Day Marker */}
                        <div className="relative pl-12">
                             <div className="absolute left-4 top-1 w-4 h-4 rounded-full bg-gray-700 z-10 border-4 border-black"></div>
                             <div className="text-sm text-slate-500 italic">Day {currentDayData.day} çµæŸ â€¢ ä¼‘æ¯å……é›» ğŸ”‹</div>
                        </div>
                    </div>
                </main>

                <footer className="py-8 text-center text-slate-700 text-xs border-t border-gray-900/50 mt-8">
                    <p>Travel Plan 2025 â€¢ Built with Vibe Coding</p>
                    <p>Powered by Google Gemini & Firebase Firestore</p>
                </footer>
                
                {/* Modal Display */}
                {selectedEvent && (
                    <EventDetailModal
                        event={itineraryData[selectedEvent.dayIndex].events[selectedEvent.eventIndex]}
                        dayIndex={selectedEvent.dayIndex}
                        eventIndex={selectedEvent.eventIndex}
                        prevLoc={selectedEvent.prevLoc}
                        onClose={handleCloseModal}
                        db={db}
                        userId={userId}
                    />
                )}
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    // Render only after the global firebase object is available
    window.addEventListener('load', () => {
        root.render(<App />);
    });
</script>
</body>
</html>