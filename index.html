<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼è¡Œç¨‹è¦åŠƒå™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light background for a clean vibe */
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden">
        
        <!-- Header -->
        <header class="p-6 bg-indigo-600 text-white shadow-lg">
            <h1 class="text-3xl font-bold tracking-tight">
                å±±é™½èˆ‡é—œè¥¿ 8 æ—¥ä¹‹æ—…
            </h1>
            <p class="text-indigo-200 mt-1">äº’å‹•å¼è¡Œç¨‹è¦åŠƒèˆ‡å„²å­˜</p>
        </header>

        <!-- Control Panel -->
        <div class="p-6 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0">
            <div id="auth-status" class="text-sm text-gray-600 flex items-center space-x-2">
                <svg id="auth-icon" class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span id="auth-text">åˆå§‹åŒ–é©—è­‰...</span>
            </div>
            <div class="flex space-x-3">
                <button id="load-btn" class="px-4 py-2 bg-green-500 text-white text-sm font-medium rounded-xl shadow hover:bg-green-600 transition duration-150 flex items-center disabled:opacity-50" disabled>
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    è¼‰å…¥è¡Œç¨‹
                </button>
                <button id="save-btn" class="px-4 py-2 bg-indigo-500 text-white text-sm font-medium rounded-xl shadow hover:bg-indigo-600 transition duration-150 flex items-center disabled:opacity-50" disabled>
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    å„²å­˜è¡Œç¨‹
                </button>
            </div>
        </div>

        <!-- Itinerary List -->
        <div id="itinerary-container" class="p-4 sm:p-6 space-y-4">
            <!-- Itinerary days will be rendered here -->
            <div class="text-center py-10 text-gray-500" id="loading-spinner">è¼‰å…¥ä¸­...</div>
        </div>
        
        <!-- Footer / Message Bar -->
        <div id="message-bar" class="p-4 bg-gray-50 text-sm text-center text-gray-600 border-t border-gray-100 hidden">
            è¡Œç¨‹å·²æˆåŠŸå„²å­˜/è¼‰å…¥ã€‚
        </div>

        <!-- Modal for Itinerary Details (Not fully implemented, but structure is here) -->
        <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
                <h3 class="text-xl font-bold mb-4">äº‹ä»¶è©³æƒ…</h3>
                <p id="modal-content"></p>
                <button onclick="document.getElementById('modal-container').classList.add('hidden')" class="mt-4 px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600">é—œé–‰</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firestore åµéŒ¯æ—¥èªŒ
        setLogLevel('Debug');

        // å…¨åŸŸè®Šæ•¸ï¼Œå¾ Canvas ç’°å¢ƒæä¾›
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase æœå‹™å¯¦ä¾‹
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        const PUBLIC_COLLECTION_PATH = `/artifacts/${appId}/public/data/itineraries`;
        const DOCUMENT_ID = 'main-trip'; // ç”¨æ–¼å„²å­˜å’Œè¼‰å…¥è¡Œç¨‹çš„å›ºå®šæ–‡ä»¶ ID

        // åˆå§‹è¡Œç¨‹æ•¸æ“š
        let itineraryData = [
            { day: "ç¬¬1å¤©", date: "2025/11/27", expanded: true, events: [
                { time: "00:50", location: "HKGÂ·é¦™æ¸¯åœ‹éš›æ©Ÿå ´", duration: "01æ™‚00åˆ†", icon: "âœˆï¸" },
                { time: "06:20", location: "KIXÂ·é—œè¥¿åœ‹éš›æ©Ÿå ´", duration: "01æ™‚00åˆ†", icon: "âœˆï¸" },
                { time: "08:25", location: "JRä¸‰å®®ç«™", duration: "00æ™‚20åˆ†", icon: "ğŸš†" },
                { time: "09:02", location: "æ–°ç¥æˆ¶", duration: "00æ™‚25åˆ†", icon: "ğŸš†" },
                { time: "09:53", location: "å§¬è·¯", duration: "00æ™‚00åˆ†", icon: "ğŸš¶" },
                { time: "10:19", location: "å§¬è·¯åŸ", duration: "01æ™‚30åˆ†", icon: "ğŸ°" },
                { time: "12:05", location: "å¥½å¤åœ’", duration: "00æ™‚30åˆ†", icon: "ğŸŒ³" },
                { time: "12:43", location: "ç¥æˆ¶ç‰›ä¸²ç‡’ Kushiyaki Kobe beef", duration: "01æ™‚00åˆ†", icon: "ğŸ¥©" },
                { time: "14:39", location: "ç¾åˆ©å …å…¬åœ’", duration: "00æ™‚30åˆ†", icon: "ğŸš¢" },
                { time: "15:21", location: "ç¥æˆ¶è‡¨æµ·æ¨‚åœ’ umie", duration: "02æ™‚30åˆ†", icon: "ğŸ›ï¸" },
                { time: "18:07", location: "JRä¸‰å®®ç«™", duration: "00æ™‚20åˆ†", icon: "ğŸš†" },
                { time: "19:10", location: "VIA INN å²¡å±±", duration: "00æ™‚20åˆ†", icon: "ğŸ¨" },
                { time: "19:41", location: "æ°¸æ—ºå¤¢æ¨‚åŸ å²¡å±±", duration: "01æ™‚00åˆ†", icon: "ğŸ›’" },
                { time: "20:47", location: "Tan-ya Bizen (Aeon Mall Okayama)", duration: "01æ™‚00åˆ†", icon: "ğŸ½ï¸" },
                { time: "21:59", location: "VIA INN å²¡å±±", duration: "01æ™‚00åˆ†", icon: "ğŸ›Œ" },
            ]},
            { day: "ç¬¬2å¤©", date: "2025/11/28", expanded: false, events: [
                { time: "06:00", location: "VIA INN å²¡å±±", duration: "01æ™‚15åˆ†", icon: "â°" },
                { time: "08:30", location: "å®®å³¶å£", duration: "00æ™‚00åˆ†", icon: "ğŸš¢" },
                { time: "08:33", location: "JR Miyajima Ferry", duration: "00æ™‚10åˆ†", icon: "â›´ï¸" },
                { time: "09:21", location: "åš´å³¶ç¥ç¤¾", duration: "02æ™‚00åˆ†", icon: "â›©ï¸" },
                { time: "11:29", location: "ç´…è‘‰è°·å…¬åœ’", duration: "00æ™‚40åˆ†", icon: "ğŸ" },
                { time: "12:47", location: "JR Miyajima Ferry", duration: "00æ™‚00åˆ†", icon: "â›´ï¸" },
                { time: "13:25", location: "Takara", duration: "01æ™‚00åˆ†", icon: "ğŸ½ï¸" },
                { time: "14:36", location: "å»£å³¶å’Œå¹³ç´€å¿µè³‡æ–™é¤¨", duration: "00æ™‚45åˆ†", icon: "ğŸ›ï¸" },
                { time: "15:24", location: "å»£å³¶å’Œå¹³ç´€å¿µå…¬åœ’", duration: "00æ™‚25åˆ†", icon: "ğŸŒ³" },
                { time: "15:55", location: "åŸå­å½ˆçˆ†ç‚¸åœ“é ‚å±‹", duration: "00æ™‚25åˆ†", icon: "ğŸ’€" },
                { time: "16:24", location: "å»£å³¶ç´™é¶´å¡”", duration: "00æ™‚35åˆ†", icon: "ğŸ—¼" },
                { time: "17:11", location: "å»£å³¶åŸ", duration: "00æ™‚30åˆ†", icon: "ğŸ°" },
                { time: "18:06", location: "BicCamera å»£å³¶ç«™å‰åº—", duration: "01æ™‚00åˆ†", icon: "ğŸ“¸" },
                { time: "19:31", location: "åºƒå³¶ç‰¡è £å‡¦ å¤§è¡†é…’å ´ãƒã‚±ãƒ„ ç«‹ç”ºåº—", duration: "01æ™‚00åˆ†", icon: "ğŸ¦ª" },
                { time: "20:54", location: "å»£å³¶", duration: "00æ™‚10åˆ†", icon: "ğŸš†" },
                { time: "21:51", location: "VIA INN å²¡å±±", duration: "01æ™‚00åˆ†", icon: "ğŸ›Œ" },
            ]},
            { day: "ç¬¬3å¤©", date: "2025/11/29", expanded: false, events: [
                { time: "08:00", location: "VIA INN å²¡å±±", duration: "01æ™‚30åˆ†", icon: "â°" },
                { time: "09:51", location: "å‰å‚™æ´¥ç¥ç¤¾", duration: "00æ™‚30åˆ†", icon: "â›©ï¸" },
                { time: "10:30", location: "å‰å‚™æ´¥å½¥ç¥ç¤¾", duration: "00æ™‚30åˆ†", icon: "â›©ï¸" },
                { time: "11:15", location: "å‰µå‘³é­šèœ å²©æ‰‹å·", duration: "00æ™‚45åˆ†", icon: "ğŸ½ï¸" },
                { time: "12:18", location: "é˜¿æ™ºç¥ç¤¾", duration: "01æ™‚00åˆ†", icon: "â›©ï¸" },
                { time: "13:25", location: "å€‰æ•·ç¾è§€åœ°å€", duration: "01æ™‚00åˆ†", icon: "ğŸ˜ï¸" },
                { time: "14:27", location: "æœ‰é„°åºµ", duration: "01æ™‚00åˆ†", icon: "â˜•" },
                { time: "15:29", location: "å€‰æ•·æ¡ƒå­ ç¸½æœ¬åº—", duration: "00æ™‚00åˆ†", icon: "ğŸ‘" },
                { time: "15:50", location: "ä¸‰äº•OUTLETå€‰æ•·", duration: "02æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "18:16", location: "å²¡å±±ä¸€ç•ªè¡—", duration: "01æ™‚00åˆ†", icon: "ğŸ›’" },
                { time: "19:22", location: "Yakiniku dining Hachiya Honcho shop", duration: "01æ™‚00åˆ†", icon: "ğŸ¥©" },
                { time: "20:26", location: "é©šå®‰ã®æ®¿å ‚ å”å‰è¨¶å¾· å²¡å±±ç«™å‰åº—", duration: "01æ™‚00åˆ†", icon: "ğŸ›’" },
                { time: "21:35", location: "VIA INN å²¡å±±", duration: "01æ™‚00åˆ†", icon: "ğŸ›Œ" },
            ]},
            { day: "ç¬¬4å¤©", date: "2025/11/30", expanded: false, events: [
                { time: "08:00", location: "VIA INN å²¡å±±", duration: "00æ™‚45åˆ†", icon: "â°" },
                { time: "09:04", location: "å²¡å±±åŸ", duration: "00æ™‚30åˆ†", icon: "ğŸ°" },
                { time: "09:40", location: "å²¡å±±å¾Œæ¨‚åœ’", duration: "00æ™‚30åˆ†", icon: "ğŸŒ³" },
                { time: "10:37", location: "400â„ƒ PIZZA ãƒ¢ãƒªãƒãƒãƒ (2å·åº—)", duration: "00æ™‚45åˆ†", icon: "ğŸ•" },
                { time: "12:18", location: "å°¾é“", duration: "00æ™‚10åˆ†", icon: "ğŸš†" },
                { time: "12:32", location: "é§…å‰å•†åº—è¡— ãŠã®ã¿ã¡", duration: "00æ™‚15åˆ†", icon: "ğŸ›ï¸" },
                { time: "12:51", location: "Uminomieru Park", duration: "00æ™‚20åˆ†", icon: "ğŸï¸" },
                { time: "13:14", location: "Karasawa Ice Cream", duration: "00æ™‚25åˆ†", icon: "ğŸ¦" },
                { time: "13:50", location: "åƒå…‰å¯ºå±±çºœè»Š å±±éº“ç«™", duration: "00æ™‚10åˆ†", icon: "ğŸš " },
                { time: "14:15", location: "åƒå…‰å¯ºå±±çºœè»Š", duration: "00æ™‚00åˆ†", icon: "ğŸš " },
                { time: "14:16", location: "åƒå…‰å¯ºå…¬åœ’é ‚ä¸Šå±•æœ›å°", duration: "00æ™‚30åˆ†", icon: "ğŸ”­" },
                { time: "14:50", location: "åƒå…‰å¯º", duration: "00æ™‚30åˆ†", icon: "ğŸ™" },
                { time: "15:23", location: "é¼“å²©", duration: "00æ™‚30åˆ†", icon: "ğŸª¨" },
                { time: "16:08", location: "è²“ä¹‹ç´°é“", duration: "00æ™‚30åˆ†", icon: "ğŸˆ" },
                { time: "16:46", location: "å°¾é“æ‹‰éºµ å£¹ç•ªé¤¨æœ¬åº—", duration: "01æ™‚00åˆ†", icon: "ğŸœ" },
                { time: "17:57", location: "æŒå…‰å¯ºå‚é“", duration: "00æ™‚15åˆ†", icon: "ğŸ™" },
                { time: "18:14", location: "å°¾é“æœ¬é€šå•†åº—è¡—", duration: "00æ™‚30åˆ†", icon: "ğŸ›ï¸" },
                { time: "19:27", location: "VIA INN å²¡å±±", duration: "01æ™‚00åˆ†", icon: "ğŸ›Œ" },
            ]},
            { day: "ç¬¬5å¤©", date: "2025/12/01", expanded: false, events: [
                { time: "08:00", location: "VIA INN å²¡å±±", duration: "01æ™‚30åˆ†", icon: "â°" },
                { time: "10:24", location: "æ–°å¤§é˜ª", duration: "00æ™‚30åˆ†", icon: "ğŸš†" },
                { time: "11:43", location: "JRåµ¯å³¨åµå±±ç«™", duration: "00æ™‚00åˆ†", icon: "ğŸš†" },
                { time: "11:58", location: "åµå±±ç«¹æ—å°å¾‘", duration: "01æ™‚00åˆ†", icon: "ğŸ" },
                { time: "13:11", location: "è•éº¥éºµ åµå±±ã‚ˆã—ã‚€ã‚‰", duration: "01æ™‚00åˆ†", icon: "ğŸœ" },
                { time: "14:17", location: "Wagyu Volcano OAGARI, Arashiyama", duration: "00æ™‚00åˆ†", icon: "ğŸ¥©" },
                { time: "14:23", location: "æ¸¡æœˆæ©‹", duration: "01æ™‚00åˆ†", icon: "ğŸŒ‰" },
                { time: "15:59", location: "äº¬éƒ½å…«å‚ç¥ç¤¾", duration: "00æ™‚30åˆ†", icon: "â›©ï¸" },
                { time: "16:52", location: "äº¬éƒ½ç«™", duration: "00æ™‚10åˆ†", icon: "ğŸš†" },
                { time: "17:40", location: "æ–°å¤§é˜ª", duration: "00æ™‚15åˆ†", icon: "ğŸš†" },
                { time: "18:19", location: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", duration: "00æ™‚35åˆ†", icon: "ğŸ¨" },
                { time: "19:13", location: "æ¾å³¶æ–°åœ°", duration: "01æ™‚00åˆ†", icon: "ğŸŒƒ" },
                { time: "20:32", location: "é“é “å €", duration: "01æ™‚00åˆ†", icon: "ğŸ¦€" },
                { time: "21:35", location: "å”å‰è¨¶å¾· é“é “å €å¾¡å ‚ç­‹åº—", duration: "01æ™‚00åˆ†", icon: "ğŸ›’" },
                { time: "22:37", location: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", duration: "01æ™‚00åˆ†", icon: "ğŸ›Œ" },
            ]},
            { day: "ç¬¬6å¤©", date: "2025/12/02", expanded: false, events: [
                { time: "08:00", location: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", duration: "02æ™‚20åˆ†", icon: "â°" },
                { time: "10:31", location: "é«˜å³¶å±‹ å¤§é˜ªåº—", duration: "01æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "11:36", location: "é›£æ³¢ä¸¸äº•", duration: "01æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "12:52", location: "ç¾åœ‹æ‘", duration: "01æ™‚00åˆ†", icon: "ğŸ‘•" },
                { time: "14:10", location: "LUCUA 1100", duration: "01æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "15:18", location: "Hankyu Department Store Umeda Main Store", duration: "01æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "16:21", location: "æ–°æ¢…ç”°ç¾é£Ÿè¡—", duration: "01æ™‚00åˆ†", icon: "ğŸ½ï¸" },
                { time: "17:26", location: "LINKS UMEDA", duration: "01æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "18:29", location: "Luck Rack LINKS UMEDA Store", duration: "01æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "19:34", location: "GRAND FRONT å¤§é˜ª åŒ—é¤¨", duration: "01æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "20:58", location: "å¿ƒé½‹æ©‹", duration: "01æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "22:13", location: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", duration: "01æ™‚00åˆ†", icon: "ğŸ›Œ" },
            ]},
            { day: "ç¬¬7å¤©", date: "2025/12/03", expanded: false, events: [
                { time: "08:00", location: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", duration: "02æ™‚30åˆ†", icon: "â°" },
                { time: "11:08", location: "æ˜¥é§’å£½å¸ æœ¬åº—", duration: "01æ™‚00åˆ†", icon: "ğŸ£" },
                { time: "12:29", location: "å¤©ç¥æ©‹ç­‹å•†åº—è¡—", duration: "01æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "13:52", location: "å››å¤©ç‹å¯º", duration: "00æ™‚30åˆ†", icon: "ğŸ™" },
                { time: "14:32", location: "å €è¶Šç¥ç¤¾", duration: "00æ™‚30åˆ†", icon: "â›©ï¸" },
                { time: "15:20", location: "é£›ç”°æ–°åœ°", duration: "01æ™‚00åˆ†", icon: "ğŸŒƒ" },
                { time: "16:29", location: "é€šå¤©é–£", duration: "01æ™‚00åˆ†", icon: "ğŸ—¼" },
                { time: "17:32", location: "æ–°ä¸–ç•Œå¸‚å ´", duration: "01æ™‚00åˆ†", icon: "ğŸ›ï¸" },
                { time: "18:52", location: "å¤©ç‹å¯ºå…¬åœ’", duration: "02æ™‚00åˆ†", icon: "ğŸŒ³" },
                { time: "21:15", location: "é©šå®‰æ®¿å ‚å”å‰è¨¶å¾·é›£æ³¢åƒæ—¥å‰åº—", duration: "01æ™‚00åˆ†", icon: "ğŸ›’" },
                { time: "22:27", location: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", duration: "01æ™‚00åˆ†", icon: "ğŸ›Œ" },
            ]},
            { day: "ç¬¬8å¤©", date: "2025/12/04", expanded: false, events: [
                { time: "08:00", location: "é›£æ³¢èˆ¹èˆ¶æ—…é¤¨", duration: "03æ™‚00åˆ†", icon: "â°" },
                { time: "11:57", location: "è‡¨ç©ºåŸ", duration: "00æ™‚00åˆ†", icon: "ğŸš†" },
                { time: "12:10", location: "ã‚Šã‚“ãã†ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ»ã‚¢ã‚¦ãƒˆãƒ¬ãƒƒãƒˆ", duration: "02æ™‚35åˆ†", icon: "ğŸ›ï¸" },
                { time: "14:58", location: "è‡¨ç©ºåŸ", duration: "00æ™‚10åˆ†", icon: "ğŸš†" },
                { time: "15:38", location: "KIXÂ·é—œè¥¿åœ‹éš›æ©Ÿå ´", duration: "02æ™‚27åˆ†", icon: "âœˆï¸" },
                { time: "22:35", location: "HKGÂ·é¦™æ¸¯åœ‹éš›æ©Ÿå ´", duration: "00æ™‚00åˆ†", icon: "ğŸ " },
            ]},
        ];

        // --- Firebase åˆå§‹åŒ–èˆ‡å…¨åŸŸå‡½æ•¸å®šç¾© (ä¸ä¾è³´ DOM) ---

        // Firebase æœå‹™å¯¦ä¾‹ (Auth/Firestore/App å¿…é ˆå…ˆå®šç¾©)
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
        }

        const itineraryRef = () => doc(db, PUBLIC_COLLECTION_PATH, DOCUMENT_ID);

        // ä»¥ä¸‹å‡½æ•¸æœƒè¢« DOMContentLoaded å…§éƒ¨çš„ç¨‹å¼ç¢¼å‘¼å«ï¼Œéœ€è¦å‚³å…¥å…ƒç´ å¼•ç”¨
        function showMessageBar(messageBar, message, type = 'gray') {
            if (!messageBar) return;
            messageBar.textContent = message;
            messageBar.className = `p-4 text-sm text-center border-t border-gray-100 block`;
            
            messageBar.classList.remove('bg-gray-50', 'bg-green-100', 'bg-red-100', 'bg-yellow-100', 'text-gray-600', 'text-green-800', 'text-red-800', 'text-yellow-800');

            if (type === 'green') {
                messageBar.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'red') {
                messageBar.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'orange') {
                messageBar.classList.add('bg-yellow-100', 'text-yellow-800');
            } else {
                messageBar.classList.add('bg-gray-50', 'text-gray-600');
            }
            
            messageBar.classList.remove('hidden');
            setTimeout(() => {
                messageBar.classList.add('hidden');
            }, 5000);
        }

        // å‡½æ•¸ï¼šæ§åˆ¶å–®æ—¥è¡Œç¨‹çš„å±•é–‹/æ”¶åˆ
        function toggleDay(index, renderFunction) {
            const dayElement = document.getElementById(`day-${index}-content`);
            if (dayElement) {
                dayElement.classList.toggle('hidden');
                itineraryData[index].expanded = !dayElement.classList.contains('hidden');
            }
            renderFunction(itineraryData); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç®­é ­æ–¹å‘
        }

        // å‡½æ•¸ï¼šæ¸²æŸ“æ•´å€‹è¡Œç¨‹åˆ—è¡¨ (éœ€è¦å¼•ç”¨ DOM å…ƒç´ å’Œ toggleDay å‡½æ•¸)
        function renderItinerary(itineraryContainer, modalContent, modalContainer, currentData) {
            if (!itineraryContainer) return;

            itineraryContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
            
            currentData.forEach((day, dayIndex) => {
                const isExpanded = day.expanded;
                
                const dayCard = document.createElement('div');
                dayCard.className = 'bg-white border border-gray-200 rounded-2xl shadow-sm transition hover:shadow-md overflow-hidden';

                const header = document.createElement('button');
                header.className = 'w-full flex justify-between items-center p-5 cursor-pointer bg-gray-50 hover:bg-gray-100 transition duration-150';
                // ä½¿ç”¨åŒ¿åå‡½æ•¸ä¾†å‚³é renderItinerary å‡½æ•¸æœ¬èº«
                header.onclick = () => toggleDay(dayIndex, (data) => renderItinerary(itineraryContainer, modalContent, modalContainer, data));
                header.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-xl font-semibold text-indigo-700">${day.day}</span>
                        <span class="text-sm font-medium text-gray-500">(${day.date})</span>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 transform transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                `;
                dayCard.appendChild(header);

                const content = document.createElement('div');
                content.id = `day-${dayIndex}-content`;
                content.className = `p-4 space-y-3 border-t border-gray-100 ${isExpanded ? '' : 'hidden'}`;
                
                day.events.forEach((event) => {
                    const eventItem = document.createElement('div');
                    
                    const isShortStop = event.duration.includes('00æ™‚00åˆ†') || event.duration.includes('00æ™‚10åˆ†');
                    const bgColor = isShortStop ? 'bg-indigo-50' : 'bg-white';
                    const textColor = isShortStop ? 'text-indigo-700' : 'text-gray-800';
                    const badgeColor = isShortStop ? 'text-indigo-500' : 'text-green-500';

                    eventItem.className = `flex items-start p-3 rounded-xl border border-gray-100 shadow-sm ${bgColor} hover:shadow-md transition duration-150 cursor-pointer`;
                    
                    eventItem.innerHTML = `
                        <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center text-2xl rounded-full border-2 border-gray-200 mr-4">
                            ${event.icon}
                        </div>
                        <div class="flex-grow">
                            <p class="text-xs font-semibold uppercase tracking-wider text-gray-400">${event.time}</p>
                            <h4 class="text-lg font-medium ${textColor} leading-tight">${event.location}</h4>
                        </div>
                        <div class="flex-shrink-0 ml-4 text-right">
                            <span class="inline-flex items-center text-xs font-bold ${badgeColor}">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                ${event.duration.replace('æ™‚', 'h').replace('åˆ†', 'm')}
                            </span>
                        </div>
                    `;
                    
                    eventItem.onclick = () => {
                        if (modalContent && modalContainer) {
                            modalContent.innerHTML = `
                                <p><strong>åœ°é»:</strong> ${event.location}</p>
                                <p><strong>æ™‚é–“:</strong> ${event.time}</p>
                                <p><strong>åœç•™æ™‚é–“:</strong> ${event.duration}</p>
                                <p class="mt-4 text-sm text-gray-500">é€™æ˜¯ä¸€å€‹æ¨¡æ“¬è©³æƒ…è¦–çª—ã€‚åœ¨çœŸæ­£çš„æ‡‰ç”¨ä¸­ï¼Œæ‚¨å¯ä»¥ç·¨è¼¯é€™äº›ç´°ç¯€ã€‚</p>
                            `;
                            modalContainer.classList.remove('hidden');
                        }
                    };

                    content.appendChild(eventItem);
                });

                dayCard.appendChild(content);
                itineraryContainer.appendChild(dayCard);
            });
        }
        
        // ç¢ºä¿æ‰€æœ‰ DOM å…ƒç´ æº–å‚™å°±ç·’å¾Œæ‰é–‹å§‹åŸ·è¡Œä¸»é‚è¼¯
        window.addEventListener('DOMContentLoaded', () => {

            // å­˜å– DOM å…ƒç´ 
            const authStatusElement = document.getElementById('auth-text');
            const authIconElement = document.getElementById('auth-icon');
            const loadBtn = document.getElementById('load-btn');
            const saveBtn = document.getElementById('save-btn');
            const itineraryContainer = document.getElementById('itinerary-container');
            const messageBar = document.getElementById('message-bar');
            const loadingSpinner = document.getElementById('loading-spinner');
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            
            // ç”±æ–¼ save/load å‡½æ•¸ç¾åœ¨éœ€è¦ messageBar å¼•ç”¨ï¼Œæˆ‘å€‘å°‡å®ƒå€‘é‡æ–°å®šç¾©ç‚ºé–‰åŒ…å…§çš„å‡½æ•¸
            
            async function saveItinerary() {
                if (!isAuthReady) {
                    showMessageBar(messageBar, "è«‹å…ˆç­‰å¾…èªè­‰å®Œæˆã€‚", 'red');
                    return;
                }
                saveBtn.disabled = true;

                try {
                    const dataToSave = {
                        itinerary: itineraryData.map(day => ({
                            day: day.day,
                            date: day.date,
                            expanded: day.expanded,
                            events: day.events
                        })),
                        updatedAt: new Date().toISOString(),
                        updatedBy: userId
                    };
                    
                    await setDoc(itineraryRef(), dataToSave);
                    showMessageBar(messageBar, "è¡Œç¨‹å·²æˆåŠŸå„²å­˜åˆ°é›²ç«¯ï¼", 'green');
                } catch (error) {
                    console.error("å„²å­˜è¡Œç¨‹å¤±æ•—:", error);
                    showMessageBar(messageBar, "å„²å­˜è¡Œç¨‹å¤±æ•—ï¼š" + error.message, 'red');
                } finally {
                    saveBtn.disabled = false;
                }
            }

            async function loadItinerary() {
                if (!isAuthReady) {
                    showMessageBar(messageBar, "è«‹å…ˆç­‰å¾…èªè­‰å®Œæˆã€‚", 'red');
                    return;
                }
                loadBtn.disabled = true;

                try {
                    const docSnap = await getDoc(itineraryRef());
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data && data.itinerary) {
                            itineraryData = data.itinerary;
                            renderItinerary(itineraryContainer, modalContent, modalContainer, itineraryData);
                            showMessageBar(messageBar, "è¡Œç¨‹å·²å¾é›²ç«¯è¼‰å…¥ã€‚", 'green');
                        } else {
                            showMessageBar(messageBar, "é›²ç«¯æ–‡ä»¶å…§å®¹ç„¡æ•ˆã€‚", 'red');
                        }
                    } else {
                        showMessageBar(messageBar, "é›²ç«¯æ‰¾ä¸åˆ°å„²å­˜çš„è¡Œç¨‹ï¼Œå°‡ä½¿ç”¨åˆå§‹æ•¸æ“šã€‚", 'orange');
                        renderItinerary(itineraryContainer, modalContent, modalContainer, itineraryData);
                    }
                } catch (error) {
                    console.error("è¼‰å…¥è¡Œç¨‹å¤±æ•—:", error);
                    showMessageBar(messageBar, "è¼‰å…¥è¡Œç¨‹å¤±æ•—ï¼š" + error.message, 'red');
                } finally {
                    loadBtn.disabled = false;
                }
            }
            
            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            if (loadBtn) loadBtn.addEventListener('click', loadItinerary);
            if (saveBtn) saveBtn.addEventListener('click', saveItinerary);


            // 1. è™•ç†èªè­‰
            if (auth) {
                onAuthStateChanged(auth, async (user) => {
                    try {
                        if (user) {
                            userId = user.uid;
                            if (authIconElement) authIconElement.classList.replace('text-gray-400', 'text-green-500');
                            if (authStatusElement) authStatusElement.textContent = `å·²é©—è­‰ä½¿ç”¨è€… (${userId.substring(0, 8)}...)`;
                            isAuthReady = true;
                        } else if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            // onAuthStateChanged æœƒå†æ¬¡è§¸ç™¼
                        } else {
                            await signInAnonymously(auth);
                            // onAuthStateChanged æœƒå†æ¬¡è§¸ç™¼
                        }
                    } catch (error) {
                        console.error("Firebase èªè­‰å¤±æ•—:", error);
                        if (authIconElement) authIconElement.classList.replace('text-gray-400', 'text-red-500');
                        if (authStatusElement) authStatusElement.textContent = "èªè­‰å¤±æ•— (åŒ¿å)";
                        isAuthReady = true;
                    }

                    if (isAuthReady) {
                        if (loadBtn) loadBtn.disabled = false;
                        if (saveBtn) saveBtn.disabled = false;
                        
                        // åœ¨èªè­‰æº–å‚™å°±ç·’å¾Œï¼Œæ¸²æŸ“åˆå§‹æ•¸æ“šä¸¦é–‹å§‹ç›£è½
                        renderItinerary(itineraryContainer, modalContent, modalContainer, itineraryData);
                        if (loadingSpinner) loadingSpinner.classList.add('hidden');
                        
                        // 2. è¨­å®šå³æ™‚ç›£è½ (Optional for this public doc, but good practice)
                        setupSnapshotListener(itineraryContainer, modalContent, modalContainer, messageBar);
                    }
                });
            } else {
                // å¦‚æœ Firebase åˆå§‹åŒ–å¤±æ•— (app/db/auth ç‚º null)
                if (authStatusElement) authStatusElement.textContent = "Firebase æœå‹™ç„¡æ³•ä½¿ç”¨";
                if (loadingSpinner) loadingSpinner.classList.add('hidden');
            }
            
            function setupSnapshotListener(itineraryContainer, modalContent, modalContainer, messageBar) {
                if (!isAuthReady) return;

                // å³æ™‚ç›£è½å…¬å…±è¡Œç¨‹æ–‡ä»¶çš„è®Šæ›´
                onSnapshot(itineraryRef(), (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        if (data && data.itinerary) {
                            itineraryData = data.itinerary;
                            renderItinerary(itineraryContainer, modalContent, modalContainer, itineraryData);
                            showMessageBar(messageBar, "è¡Œç¨‹å·²å¾é›²ç«¯å³æ™‚æ›´æ–°ã€‚", 'green');
                        }
                    } else {
                        // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œç¢ºä¿ä½¿ç”¨æœ¬åœ°æ•¸æ“š
                        console.log("é›²ç«¯è¡Œç¨‹æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨æœ¬åœ°åˆå§‹æ•¸æ“šã€‚");
                        renderItinerary(itineraryContainer, modalContent, modalContainer, itineraryData);
                    }
                }, (error) => {
                    console.error("è¨­å®š Firestore ç›£è½å¤±æ•—:", error);
                    showMessageBar(messageBar, "ç„¡æ³•ç›£è½é›²ç«¯è¡Œç¨‹æ›´æ–°ã€‚", 'red');
                });
            }
        });
        
    </script>
</body>
</html>